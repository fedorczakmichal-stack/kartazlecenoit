<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytowalna Karta Zlece≈Ñ OIT - Enhanced z Gemini</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
</head>
<body>
    <div id="toastContainer"></div>
    <div id="validationTooltip" class="validation-tooltip"></div>

    <div class="top-controls no-print">
        <button onclick="window.print()" class="control-button print" title="Drukuj (Ctrl+P)"><i class="fas fa-print"></i> Drukuj</button>
        <button onclick="generatePDF()" class="control-button pdf"><i class="fas fa-file-pdf"></i> PDF</button>
        <button onclick="summarizeCardWithGemini()" class="control-button gemini-button" title="Generuj podsumowanie karty przy u≈ºyciu AI">
            <i class="fas fa-sparkles"></i> Podsumuj Kartƒô ‚ú®
        </button>
        <button onclick="saveCard()" class="control-button save" title="Zapisz (Ctrl+S)"><i class="fas fa-save"></i> Zapisz w przeglƒÖdarce</button>
        <button onclick="openLoadModal()" class="control-button load"><i class="fas fa-folder-open"></i> Wczytaj z przeglƒÖdarki</button>
        <button onclick="openTemplatesModal()" class="control-button templates" title="Szablony kart"><i class="fas fa-clipboard-list"></i> Szablony</button>
        <button onclick="saveCardToFile()" class="control-button save-file"><i class="fas fa-file-download"></i> Zapisz do pliku</button>
        <button onclick="document.getElementById('fileInput').click()" class="control-button load-file"><i class="fas fa-file-upload"></i> Wczytaj z pliku</button>
        <input type="file" id="fileInput" style="display: none;" onchange="loadCardFromFile(event)" accept=".json">
        <button onclick="clearCard()" class="control-button clear" title="Wyczy≈õƒá (Ctrl+N)"><i class="fas fa-trash"></i> Wyczy≈õƒá</button>
        <button id="darkModeToggle" class="control-button dark-mode"><i class="fas fa-moon"></i></button>
        <div id="autosaveIndicator" class="autosave-indicator saved">
            <i class="fas fa-check-circle"></i>
            <span></span>
        </div>
        <div id="offlineIndicator" class="offline-indicator" style="display: none;">
            <i class="fas fa-wifi-slash"></i>
            <span>Tryb offline</span>
        </div>
    </div>

    <div class="container" id="card-container">
        <div class="header-section">
            <div class="hospital-header">
                <div class="hospital-logo">
                    <div class="logo-icon">üè•</div>
                    <div>
                        <div style="font-size: 13px; font-weight: 600;">Szpital Zakonu Bonifratr√≥w ≈õw. Jana Bo≈ºego w ≈Åodzi</div>
                        <div style="font-size: 10px; opacity: 0.9;">ul. Kosynier√≥w Gdy≈Ñskich 61, 93-357 ≈Å√≥d≈∫</div>
                    </div>
                </div>
                <div class="header-right-info">
                    <div class="field-group">
                        <span class="field-label">Data</span>
                        <input type="text" id="mainDateInput" class="field-value small header-input" autocomplete="off" onchange="calculateIcuDay()"/>
                    </div>
                    <div class="field-group">
                        <span class="field-label">Doba w OIT</span>
                        <input type="number" min="0" id="icuDayInput" class="field-value small header-input" autocomplete="off"/>
                    </div>
                    <div class="field-group print-only-room" style="display:none;">
                        <span class="field-label">Sala/≈Å√≥≈ºko</span>
                        <input type="text" id="roomInputPrint" class="field-value small header-input" autocomplete="off" readonly/>
                    </div>
                </div>
            </div>
            <h1>Oddzia≈Ç Anestezjologii i Intensywnej Terapii - Karta Zlece≈Ñ Lekarskich</h1>
        </div>

        <div class="patient-card">
            <div class="patient-grid">
                <div class="field-group" style="grid-column: span 2;">
                    <span class="field-label">Imiƒô i Nazwisko</span>
                    <input type="text" id="patientNameInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">PESEL</span>
                    <input type="text" id="peselInput" class="field-value header-input" autocomplete="off" maxlength="11" oninput="validatePESEL(this)"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Nr Historii</span>
                    <input type="text" id="historyNumberInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Data przyjƒôcia</span>
                    <input type="text" placeholder="DD.MM.RRRR" id="admissionDateInput" class="field-value header-input" autocomplete="off" onchange="calculateIcuDay()" oninput="validateDate(this)"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Waga (kg)</span>
                    <input type="number" id="patientWeight" class="field-value header-input" autocomplete="off" oninput="handleWeightHeightChange()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Wzrost (cm)</span>
                    <input type="number" id="heightInput" class="field-value header-input" autocomplete="off" oninput="handleWeightHeightChange()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">BMI</span>
                    <input type="text" id="bmiOutput" class="field-value header-input" autocomplete="off" readonly/>
                </div>
                <div class="field-group" style="grid-column: span 2;">
                    <span class="field-label">Rozpoznanie</span>
                    <div class="input-with-gemini">
                        <input type="text" id="diagnosisInput" class="field-value header-input" autocomplete="off" list="diagnosisList"/>
                        <button class="gemini-icon-button" onclick="suggestPlanWithGemini()" title="Zaproponuj plan opieki ‚ú®">
                            <i class="fas fa-sparkles"></i>
                        </button>
                    </div>
                </div>
                <div class="field-group">
                    <span class="field-label">GFR (ml/min)</span>
                    <input type="number" id="gfrInput" class="field-value gfr-input header-input" autocomplete="off" oninput="adjustAllDosesForGfr()"/>
                </div>
                 <div class="field-group">
                    <span class="field-label">Sala/≈Å√≥≈ºko</span>
                    <input type="text" id="roomInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group" style="grid-column: span 4;">
                    <span class="field-label">‚ö†Ô∏è ALERGIE / NIETOLERANCJE</span>
                    <input type="text" id="allergiesInput" class="field-value alert-field header-input" autocomplete="off"/>
                </div>
            </div>
        </div>

        <div class="quick-search-bar no-print">
            <i class="fas fa-search"></i>
            <input type="text" id="quickSearchInput" placeholder="Szybkie wyszukiwanie leku..." onkeyup="quickSearch(event)">
            <div id="quickSearchResults" class="search-results"></div>
        </div>

        <div class="section-header"><i class="fas fa-syringe"></i> LEKI CIƒÑG≈ÅE - POMPY INFUZYJNE</div>
        <table id="continuousDrugsTable">
<thead>
    <tr>
        <th class="drag-column no-print" style="width: 25px;"></th>
        <th style="width: 30%;">Lek / Stƒô≈ºenie</th>
        <th style="width: 35%;">Dawka</th>
        <th style="width: 10%;">Prƒôdko≈õƒá [ml/h]</th>
        <th style="width: 25%;">Podpis pielƒôgniarki</th>
        <th class="action-column no-print" style="width: 30px;"></th>
    </tr>
</thead>
            <tbody id="continuousDrugsTbody" class="sortable-tbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addContinuousDrug()" class="add-button"><i class="fas fa-plus-circle"></i> Dodaj lek ciƒÖg≈Çy</button>
        </div>

        <div class="section-header green"><i class="fas fa-pills"></i> LEKI OKRESOWE</div>
        <table id="periodicDrugsTable">
<thead>
                <tr>
                    <th class="drag-column no-print" style="width: 25px;"></th>
                    <th style="width: 30%;">Lek / Dawka</th>
                    <th style="width: 15%;">Droga / Czƒôsto≈õƒá</th>
                    <th style="width: 55%;">Podpis pielƒôgniarki</th>
                    <th class="action-column no-print" style="width: 30px;"></th>
                </tr>
            </thead>
            <tbody id="periodicDrugsTbody" class="sortable-tbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addPeriodicDrug()" class="add-button green"><i class="fas fa-plus-circle"></i> Dodaj lek okresowy</button>
        </div>

        <div class="section-header cyan"><i class="fas fa-tint"></i> P≈ÅYNOTERAPIA I ≈ªYWIENIE</div>
        <table id="fluidsTable">
             <thead>
                <tr>
                    <th class="drag-column no-print" style="width: 25px;"></th>
                    <th style="width: 20%;">P≈Çyn</th>
                    <th style="width: 35%;">Dodatki</th>
                    <th style="width: 10%;">Objƒôto≈õƒá [ml]</th>
                    <th style="width: 10%;">Prƒôdko≈õƒá [ml/h]</th>
                    <th style="width: 25%;">Podpis pielƒôgniarki</th>
                    <th class="action-column no-print" style="width: 30px;"></th>
                </tr>
            </thead>
            <tbody class="sortable-tbody"></tbody>
        </table>
        <table id="nutritionTable">
            <thead>
                <tr>
                    <th class="drag-column no-print" style="width: 25px;"></th>
                    <th style="width: 25%;">Typ ≈ºywienia</th>
                    <th style="width: 35%;">Preparat / Dodatki</th>
                    <th style="width: 15%;">Prƒôdko≈õƒá [ml/h]</th>
                    <th style="width: 25%;">Podpis pielƒôgniarki</th>
                    <th class="action-column no-print" style="width: 30px;"></th>
                </tr>
            </thead>
            <tbody class="sortable-tbody"></tbody>
        </table>
        <div class="controls-summary-container no-print">
             <div class="button-container no-print">
                <button onclick="addFluid()" class="add-button cyan"><i class="fas fa-plus-circle"></i> Dodaj p≈Çyn</button>
                <button onclick="addNutrition()" class="add-button orange"><i class="fas fa-plus-circle"></i> Dodaj ≈ºywienie</button>
            </div>
            <div class="summary-container">
                <div class="fluid-balance-indicator">
                    <div id="fluidBalanceSummary">Suma p≈Çyn√≥w / 24h: <strong><span id="totalFluids">0</span> ml</strong></div>
                    <div class="balance-bar">
                        <div class="balance-fill" id="fluidBalanceFill"></div>
                    </div>
                </div>
                <div class="kcal-indicator">
                    <div id="kcalSummary">Suma kcal / 24h: <strong><span id="totalKcal">0</span> kcal</strong> (<span id="kcalPerKg">0</span> kcal/kg)</div>
                    <div class="kcal-bar">
                        <div class="kcal-fill" id="kcalFill"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-header purple"><i class="fas fa-stethoscope"></i> PROCEDURY / ZABIEGI</div>
        <table id="proceduresTable">
            <thead>
                <tr>
                    <th class="drag-column no-print" style="width: 25px;"></th>
                    <th style="width: 15%;">Godzina</th>
                    <th style="width: 50%;">Procedura</th>
                    <th style="width: 35%;">Wykonano (podpis)</th>
                    <th class="action-column no-print" style="width: 30px;"></th>
                </tr>
            </thead>
            <tbody class="sortable-tbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addProcedure()" class="add-button purple"><i class="fas fa-plus-circle"></i> Dodaj procedurƒô</button>
        </div>

        <div class="section-header gray"><i class="fas fa-file-alt"></i> UWAGI DODATKOWE / ZALECENIA</div>
        <div class="footer-grid">
            <div class="notes-section">
                <textarea placeholder="Miejsce na dodatkowe zalecenia, uwagi, konsultacje..." autocomplete="off"></textarea>
            </div>
            <div class="signature-box">
                <div class="signature-line"></div>
                <div class="signature-label">LEKARZ DY≈ªURNY</div>
                <div class="signature-sublabel">(pieczƒÖtka i podpis)</div>
            </div>
        </div>
    </div>

    <div id="loadCardModal" class="modal no-print" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Wczytaj zapisanƒÖ kartƒô</h3>
                <span class="close" onclick="closeModal('loadCardModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>Wybierz pacjenta z listy, aby wczytaƒá jego kartƒô.</p>
                <ul id="savedCardsList"></ul>
            </div>
        </div>
    </div>

    <div id="templatesModal" class="modal no-print" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Wybierz szablon karty</h3>
                <span class="close" onclick="closeModal('templatesModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>Wybierz szablon dla typowego przypadku:</p>
                <div class="templates-grid">
                    <button class="template-button" onclick="loadTemplate('universal')"><i class="fas fa-hospital"></i><span>Uniwersalny OIT</span></button>
                    <button class="template-button" onclick="loadTemplate('cardiac')"><i class="fas fa-heartbeat"></i><span>Kardiochirurgia</span></button>
                    <button class="template-button" onclick="loadTemplate('trauma')"><i class="fas fa-user-injured"></i><span>Uraz wielonarzƒÖdowy</span></button>
                    <button class="template-button" onclick="loadTemplate('sepsis')"><i class="fas fa-virus"></i><span>Sepsa</span></button>
                    <button class="template-button" onclick="loadTemplate('respiratory')"><i class="fas fa-lungs"></i><span>Niewydolno≈õƒá oddechowa</span></button>
                    <button class="template-button" onclick="loadTemplate('neurological')"><i class="fas fa-brain"></i><span>Neurologia</span></button>
                    <button class="template-button" onclick="loadTemplate('renal')"><i class="fas fa-filter"></i><span>CRRT</span></button>
                    <!-- NOWY PRZYCISK SZABLONU TESTOWEGO -->
                    <button class="template-button test-template" onclick="loadTemplate('test')"><i class="fas fa-vial"></i><span>Test Pe≈Çne Dane</span></button>
                    <button class="template-button save-custom" onclick="saveCurrentAsTemplate()"><i class="fas fa-save"></i><span>Zapisz jako szablon</span></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gemini Response Modal -->
    <div id="geminiResponseModal" class="modal no-print" style="display: none;">
        <div class="modal-content gemini-modal-content">
            <div class="modal-header">
                <h3 id="geminiModalTitle"></h3>
                <span class="close" onclick="closeModal('geminiResponseModal')">&times;</span>
            </div>
            <div class="modal-body" id="geminiModalBody">
                <div class="gemini-loader"></div>
                <div id="geminiResponseContent" style="display: none;"></div>
            </div>
        </div>
    </div>


    <datalist id="continuousDrugsList"></datalist>
    <datalist id="periodicDrugsList"></datalist>
    <datalist id="fluidsList"></datalist>
    <datalist id="enteralProductsList"></datalist>
    <datalist id="parenteralProductsList"></datalist>
    <datalist id="nutritionTypesList">
        <option value="≈ªywienie dojelitowe"></option>
        <option value="≈ªywienie pozajelitowe"></option>
        <option value="Dieta doustna"></option>
    </datalist>
    <datalist id="proceduresList">
        <option value="Toaleta drzewa oskrzelowego"></option>
        <option value="RTG klatki piersiowej przy≈Ç√≥≈ºkowe"></option>
        <option value="Zmiana opatrunku CVC"></option>
        <option value="Zmiana pozycji cia≈Ça"></option>
        <option value="Profilaktyka odle≈ºyn"></option>
        <option value="USG p≈Çuc"></option>
        <option value="USG jamy brzusznej"></option>
        <option value="Bronchoskopia"></option>
        <option value="Wymiana rurki intubacyjnej"></option>
        <option value="Wymiana rurki tracheostomijnej"></option>
        <option value="Za≈Ço≈ºenie CVC"></option>
        <option value="Za≈Ço≈ºenie cewnika tƒôtniczego"></option>
        <option value="Za≈Ço≈ºenie cewnika Foleya"></option>
        <option value="Punkcja lƒôd≈∫wiowa"></option>
        <option value="Nak≈Çucie jamy op≈Çucnej"></option>
        <option value="Drena≈º jamy op≈Çucnej"></option>
        <option value="CRRT - rozpoczƒôcie"></option>
        <option value="CRRT - wymiana zestawu"></option>
        <option value="Hemodializa"></option>
        <option value="Plazmafereza"></option>
        <option value="Fizjoterapia"></option>
        <option value="Rehabilitacja oddechowa"></option>
        <option value="Pionizacja"></option>
        <option value="EKG"></option>
        <option value="ECHO serca"></option>
        <option value="Gastroskopia"></option>
        <option value="Kolonoskopia"></option>
        <option value="CT g≈Çowy"></option>
        <option value="CT klatki piersiowej"></option>
        <option value="CT jamy brzusznej"></option>
        <option value="Glikemia 4xd"></option>
        <option value="Zmiany u≈Ço≈ºenia"></option>
        <option value="Monitorowanie hemodynamiczne"></option>
        <option value="Kontrola zalega≈Ñ"></option>
        <option value="Kinezyterapia"></option>
        <option value="IAP 2xd"></option>
        <option value="OC≈ª 2xdz"></option>
    </datalist>
    <datalist id="diagnosisList">
        <option value="Zapalenie p≈Çuc"></option>
        <option value="Sepsa"></option>
        <option value="WstrzƒÖs septyczny"></option>
        <option value="ARDS"></option>
        <option value="Niewydolno≈õƒá oddechowa"></option>
        <option value="Niewydolno≈õƒá serca"></option>
        <option value="Ostry zesp√≥≈Ç wie≈Ñcowy"></option>
        <option value="Uraz wielonarzƒÖdowy"></option>
        <option value="Udar m√≥zgu"></option>
        <option value="Krwotok podpajƒôczyn√≥wkowy"></option>
        <option value="Stan po zatrzymaniu krƒÖ≈ºenia"></option>
        <option value="Niewydolno≈õƒá wielonarzƒÖdowa"></option>
        <option value="Ostre zapalenie trzustki"></option>
        <option value="Niewydolno≈õƒá nerek"></option>
        <option value="Niewydolno≈õƒá wƒÖtroby"></option>
    </datalist>
    <datalist id="timesList">
        <option value="06:00"></option>
        <option value="07:00"></option>
        <option value="08:00"></option>
        <option value="09:00"></option>
        <option value="10:00"></option>
        <option value="11:00"></option>
        <option value="12:00"></option>
        <option value="13:00"></option>
        <option value="14:00"></option>
        <option value="15:00"></option>
        <option value="16:00"></option>
        <option value="17:00"></option>
        <option value="18:00"></option>
        <option value="19:00"></option>
        <option value="20:00"></option>
        <option value="21:00"></option>
        <option value="22:00"></option>
        <option value="23:00"></option>
        <option value="00:00"></option>
        <option value="01:00"></option>
        <option value="02:00"></option>
        <option value="03:00"></option>
        <option value="04:00"></option>
        <option value="05:00"></option>
        <option value="co 1h"></option>
        <option value="co 2h"></option>
        <option value="co 4h"></option>
        <option value="co 6h"></option>
        <option value="co 8h"></option>
        <option value="co 12h"></option>
        <option value="co 24h"></option>
        <option value="dora≈∫nie"></option>
    </datalist>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="script.js"></script>
</body>
</html>

