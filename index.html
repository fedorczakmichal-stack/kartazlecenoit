<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytowalna Karta Zleceń OIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --primary-light: #dbeafe;

    --success: #16a34a;
    --success-dark: #15803d;

    --warning: #ea580c;
    --warning-dark: #c2410c;
    --warning-light: #fffbeb;

    --danger: #dc2626;
    --danger-dark: #b91c1c;

    --info: #0891b2;
    --info-dark: #0e7490;

    --purple: #7c3aed;
    --purple-dark: #6d28d9;
    --amber: #d97706;
    --teal: #0d9488;

    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;

    --bg-color: var(--gray-100);
    --container-bg: white;
    --text-color: var(--gray-800);
    --border-color: var(--gray-200);
    --shadow-color: rgba(0,0,0,0.05);
}

html.dark-mode {
    --bg-color: var(--gray-900);
    --container-bg: var(--gray-800);
    --text-color: var(--gray-200);
    --border-color: var(--gray-700);
    --shadow-color: rgba(0,0,0,0.2);
    --gray-50: #1f2937;
    --gray-100: #374151;
    --warning-light: #4d4400;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 11px;
    line-height: 1.5;
    color: var(--text-color);
    background: var(--bg-color);
}

.container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20mm;
    background: var(--container-bg);
    box-shadow: 0 4px 12px var(--shadow-color);
    border-radius: 8px;
}

/* Na większych ekranach zwiększ szerokość */
@media screen and (min-width: 1400px) {
    .container {
        max-width: 1400px;
        padding: 25mm;
    }
}

@media screen and (min-width: 1600px) {
    .container {
        max-width: 1600px;
    }
}

@media screen and (min-width: 1920px) {
    .container {
        max-width: 1800px;
        padding: 30mm;
    }
}

/* Hide print-only room field on screen */
.print-only-room {
    display: none !important;
}

/* Top Controls */
.top-controls {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 15px;
    background: var(--container-bg);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
}

.control-button {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    color: white;
}
.control-button.small { padding: 6px 12px; font-size: 11px; }
.control-button i { font-size: 14px; }
.control-button.print { background-color: var(--primary); }
.control-button.pdf { background-color: var(--success); }
.control-button.save { background-color: #f59e0b; }
.control-button.load { background-color: var(--info); }
.control-button.save-file { background-color: var(--amber); }
.control-button.load-file { background-color: var(--teal); }
.control-button.clear { background-color: var(--danger); }
.control-button.dark-mode { background-color: var(--gray-700); }
.control-button:hover { opacity: 0.85; }

/* Header */
.header-section {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.hospital-header { display: flex; justify-content: space-between; align-items: center; }
.hospital-logo { display: flex; align-items: center; gap: 10px; }
.logo-icon { width: 32px; height: 32px; background: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--primary); }
.header-right-info { display: flex; gap: 10px; }
.header-right-info .field-value { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: white; padding: 2px 6px; text-align: center; }
.header-right-info .field-label { color: white; opacity: 0.9; }
h1 { font-size: 14px; font-weight: 600; text-align: center; margin-top: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Patient Card */
.patient-card { background: var(--gray-50); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); }
.patient-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.field-group { display: flex; flex-direction: column; }
.field-label { font-size: 9px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
.field-value { padding: 5px 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--container-bg); font-size: 11px; min-height: 28px; width: 100%; color: var(--text-color); }
.field-value.alert-field { background: #fef2f2; border-color: var(--danger); color: var(--danger); font-weight: 600; }
html.dark-mode .field-value.alert-field { background: #450a0a; }

/* Section Headers */
.section-header { background: linear-gradient(90deg, var(--gray-800) 0%, var(--gray-900) 100%); color: white; padding: 6px 12px; border-radius: 6px; margin: 20px 0 8px 0; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.section-header.green { background: linear-gradient(90deg, var(--success) 0%, var(--success-dark) 100%); }
.section-header.orange { background: linear-gradient(90deg, var(--warning) 0%, var(--warning-dark) 100%); }
.section-header.cyan { background: linear-gradient(90deg, var(--info) 0%, var(--info-dark) 100%); }
.section-header.purple { background: linear-gradient(90deg, var(--purple) 0%, var(--purple-dark) 100%); }
.section-header.gray { background: linear-gradient(90deg, var(--gray-600) 0%, var(--gray-700) 100%); }

/* Tables */
table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
th { background: var(--gray-100); padding: 6px 8px; text-align: left; font-weight: 600; font-size: 10px; color: var(--gray-600); border-bottom: 2px solid var(--border-color); }
td { padding: 2px 8px; border-bottom: 1px solid var(--border-color); vertical-align: middle; height: 28px; }
tr:last-child td { border-bottom: none; }
tbody tr:hover { background: var(--gray-50); }

/* GFR Dose Adjustment Styling */
tr.gfr-dose-adjusted td { background-color: var(--warning-light) !important; }
.dose-reduction-notice { font-size: 10px; color: var(--warning-dark); font-weight: 500; margin-left: 5px; }
html.dark-mode .dose-reduction-notice { color: #facc15; }

/* Inputs inside tables */
.drug-input { 
    width: 100%; 
    border: none; 
    background: transparent; 
    font-size: 11px; 
    padding: 2px; 
    color: var(--text-color); 
    font-family: inherit;
}
.drug-input:focus { outline: none; background: var(--primary-light); }
.drug-name { font-weight: 500; }
.infusion-rate { font-weight: 600; color: var(--success-dark); }
html.dark-mode .infusion-rate { color: #4ade80; }
.nutrition-rate { font-weight: 500; color: var(--warning-dark); }
html.dark-mode .nutrition-rate { color: #facc15; }
.nutrition-type { font-weight: 500; color: var(--info-dark); }
html.dark-mode .nutrition-type { color: #38bdf8; }

.signature-box-cell { 
    border: 1px solid var(--border-color); 
    height: 100%; 
    background: linear-gradient(to bottom, var(--container-bg), var(--gray-50)); 
    border-radius: 2px; 
}
.additives-input {
    font-size: 10px;
    color: var(--gray-600);
}
.nutrition-additives {
    font-size: 9px;
    color: var(--gray-600);
    margin-top: 2px;
    padding: 1px 2px;
    resize: none;
    min-height: 20px;
    line-height: 1.4;
}
html.dark-mode .nutrition-additives {
    color: var(--gray-400);
}

/* Buttons */
.button-container { display: flex; justify-content: flex-start; gap: 10px; margin-bottom: 15px; }
.add-button { display: flex; align-items: center; gap: 6px; background-color: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 500; transition: background-color 0.2s; }
.add-button:hover { background-color: var(--primary-dark); }
.add-button.green { background-color: var(--success); }
.add-button.green:hover { background-color: var(--success-dark); }
.add-button.cyan { background-color: var(--info); }
.add-button.cyan:hover { background-color: var(--info-dark); }
.add-button.orange { background-color: var(--warning); }
.add-button.orange:hover { background-color: var(--warning-dark); }
.add-button.purple { background-color: var(--purple); }
.add-button.purple:hover { background-color: var(--purple-dark); }
.add-button.gray { background-color: var(--gray-500); }
.add-button.gray:hover { background-color: var(--gray-600); }
.remove-button { 
    background: none; 
    border: none; 
    color: var(--gray-400); 
    cursor: pointer; 
    font-size: 14px; 
}
.remove-button:hover { 
    color: var(--danger); 
}
.action-column { 
    width: 30px; 
    text-align: center; 
}

/* Summary */
.controls-summary-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
.summary-container { text-align: right; font-size: 12px; color: var(--gray-600); }
.summary-container strong { color: var(--text-color); }
#fluidBalanceSummary { color: var(--info); }
#kcalSummary { color: var(--warning); }

/* Footer */
.footer-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: stretch; }
.notes-section textarea { width: 100%; height: 100%; min-height: 80px; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; font-size: 11px; background: var(--container-bg); color: var(--text-color); resize: vertical; }
.signature-box { text-align: center; display: flex; flex-direction: column; justify-content: flex-end; }
.signature-line { border-bottom: 1px solid var(--gray-400); min-height: 50px; margin-bottom: 5px; }
.signature-label { font-size: 10px; color: var(--gray-600); font-weight: 600; }
.signature-sublabel { font-size: 9px; color: var(--gray-500); }

/* Modal */
.modal { 
    position: fixed; 
    z-index: 1001; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0,0,0,0.6); 
    display: none; 
    align-items: center; 
    justify-content: center;
    backdrop-filter: blur(4px);
}
.modal-content { 
    background-color: var(--container-bg); 
    border-radius: 12px; 
    width: 90%; 
    max-width: 600px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: modalSlideIn 0.3s ease-out;
}
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
.modal-header { 
    padding: 20px 24px; 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    background: var(--gray-50);
    border-radius: 12px 12px 0 0;
}
.modal-header h3 { 
    font-size: 18px; 
    font-weight: 600;
    color: var(--text-color);
}
.close { 
    font-size: 24px; 
    font-weight: bold; 
    cursor: pointer; 
    color: var(--gray-400);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
}
.close:hover { 
    color: var(--text-color);
    background: var(--gray-200);
}
.modal-body { 
    padding: 24px; 
    max-height: 60vh; 
    overflow-y: auto;
}
.modal-footer { 
    padding: 16px 24px; 
    text-align: right; 
    border-top: 1px solid var(--border-color);
    background: var(--gray-50);
    border-radius: 0 0 12px 12px;
}

/* Saved cards list in modal */
#savedCardsList {
    list-style: none;
    padding: 0;
}
#savedCardsList li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 8px;
    background: var(--gray-50);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    transition: all 0.2s;
}
#savedCardsList li:hover {
    background: var(--primary-light);
    border-color: var(--primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
}
html.dark-mode #savedCardsList li {
    background: var(--gray-700);
}
#savedCardsList .patient-name {
    font-weight: 600;
    color: var(--text-color);
    font-size: 14px;
}

/* Hide spinners in number inputs */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type="number"] {
    -moz-appearance: textfield;
    appearance: textfield;
}

/* ======= WYDRUK KOMPAKTOWY A4 ======= */

@page {
    size: A4;
    margin: 5mm;
}

@media print {
    html, body {
        background: #fff !important;
        color: #000 !important;
        font-size: 9px !important;
        line-height: 1.2 !important;
    }

    .container, #card-container {
        max-width: none !important;
        margin: 0 !important;
        padding: 3mm !important;
        background: #fff !important;
        border: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
    }

    .top-controls,
    .no-print,
    .action-column,
    .add-button,
    .button-container,
    .remove-button {
        display: none !important;
    }

    /* UKRYCIE STRZAŁEK W POLACH NUMBER */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none !important;
        margin: 0 !important;
    }
    input[type="number"] {
        -moz-appearance: textfield !important;
        appearance: textfield !important;
    }

    /* Nagłówek ultra kompaktowy */
    .header-section {
        background: none !important;
        color: #000 !important;
        border-bottom: 0.5px solid #000 !important;
        padding: 1mm 0 !important;
        margin-bottom: 2mm !important;
        border-radius: 0 !important;
        page-break-inside: avoid !important;
    }
    .hospital-header {
        margin-bottom: 1mm !important;
    }
    .logo-icon {
        width: 20px !important;
        height: 20px !important;
        background: none !important;
        color: #000 !important;
        border: 0.5px solid #000 !important;
        font-size: 12px !important;
    }
    .hospital-logo div div:first-child {
        font-size: 11px !important;
    }
    .hospital-logo div div:last-child {
        font-size: 9px !important;
    }
    
    /* Ukryj sala/łóżko z nagłówka na wydruku (zostaje tylko w tabeli pacjenta) */
    .header-right-info .print-only-room {
        display: none !important;
    }
    .header-right-info .field-group .field-value {
        background: #fff !important;
        border: 0.5px solid #000 !important;
        color: #000 !important;
        min-width: 50px !important;
        font-size: 9px !important;
    }
    .header-right-info .field-group .field-label {
        color: #000 !important;
        font-size: 8px !important;
    }
    
    h1 {
        font-size: 11px !important;
        margin: 1mm 0 0 0 !important;
        text-align: center !important;
        color: #000 !important;
        text-transform: uppercase !important;
        letter-spacing: 0 !important;
    }

    /* Karta pacjenta ultra kompaktowa */
    .patient-card {
        border: 0.5px solid #000 !important;
        background: #fff !important;
        padding: 2mm !important;
        margin-bottom: 2mm !important;
        border-radius: 0 !important;
        page-break-inside: avoid !important;
    }
    .patient-grid { 
        gap: 1.5mm !important; 
        grid-template-columns: repeat(4, 1fr) !important;
    }
    
    .field-label {
        font-size: 7px !important;
        color: #000 !important;
        margin-bottom: 1px !important;
        letter-spacing: 0.1px !important;
        text-transform: uppercase !important;
    }
    .field-value,
    .header-input,
    input.field-value,
    textarea.field-value {
        border: 0.5px solid #000 !important;
        background: #fff !important;
        color: #000 !important;
        font-size: 9px !important;
        padding: 1px 2px !important;
        min-height: 18px !important;
        border-radius: 0 !important;
    }
    .field-value.small {
        width: auto !important;
        min-width: 40px !important;
    }
    .alert-field {
        background: #fff !important;
        border: 1px solid #000 !important;
        color: #000 !important;
        font-weight: 700 !important;
    }

    /* Nagłówki sekcji kompaktowe */
    .section-header {
        background: #e0e0e0 !important;
        color: #000 !important;
        border: 0.5px solid #000 !important;
        padding: 2px 4px !important;
        border-radius: 0 !important;
        margin: 2mm 0 1mm 0 !important;
        font-size: 9px !important;
        font-weight: 700 !important;
        page-break-after: avoid !important;
    }

    /* Tabele ultra kompaktowe */
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 8px !important;
        border: 0.5px solid #000 !important;
        margin: 1mm 0 !important;
        table-layout: fixed !important;
        page-break-inside: avoid !important;
    }
    thead {
        page-break-inside: avoid !important;
        page-break-after: avoid !important;
    }
    thead th {
        background: #f0f0f0 !important;
        color: #000 !important;
        font-weight: 600 !important;
        border: 0.5px solid #000 !important;
        padding: 1.5mm !important;
        font-size: 7.5px !important;
    }
    tbody td {
        border: 0.5px solid #000 !important;
        padding: 1mm !important;
        vertical-align: top !important;
        height: auto !important;
        min-height: 22px;
        overflow: visible !important;
        word-wrap: break-word !important;
    }

    /* Specjalne reguły dla tabeli żywienia */
    #nutritionTable tbody td {
        height: auto !important;
        min-height: 28px !important;
        padding-bottom: 2mm !important;
    }
    
    #nutritionTable tbody td:nth-child(2) {
        vertical-align: top !important;
        overflow: visible !important;
    }

    /* Optymalizacja szerokości kolumn dla wydruku */
    #continuousDrugsTable th:nth-child(1) { width: 35% !important; }
    #continuousDrugsTable th:nth-child(2) { width: 25% !important; }
    #continuousDrugsTable th:nth-child(3) { width: 15% !important; }
    #continuousDrugsTable th:nth-child(4) { width: 25% !important; }

    #periodicDrugsTable th:nth-child(1) { width: 35% !important; }
    #periodicDrugsTable th:nth-child(2) { width: 20% !important; }
    #periodicDrugsTable th:nth-child(3) { width: 45% !important; }

    #fluidsTable th:nth-child(1) { width: 22% !important; }
    #fluidsTable th:nth-child(2) { width: 33% !important; }
    #fluidsTable th:nth-child(3) { width: 12% !important; }
    #fluidsTable th:nth-child(4) { width: 12% !important; }
    #fluidsTable th:nth-child(5) { width: 21% !important; }

    /* ZMIENIONE PROPORCJE KOLUMN DLA ŻYWIENIA */
    #nutritionTable th:nth-child(1) { width: 15% !important; }
    #nutritionTable th:nth-child(2) { width: 45% !important; }
    #nutritionTable th:nth-child(3) { width: 15% !important; }
    #nutritionTable th:nth-child(4) { width: 25% !important; }

    /* Pola wewnątrz tabel */
    .drug-input,
    .fluid-rate,
    .nutrition-prep,
    .nutrition-rate,
    .nutrition-type,
    .dose,
    .infusion-rate,
    .fluid-name,
    .additives-input {
        border: none !important;
        background: transparent !important;
        color: #000 !important;
        padding: 0 !important;
        font-size: 8px !important;
        -webkit-appearance: none !important;
        appearance: none !important;
    }
    
    /* POPRAWKA DLA DODATKÓW ŻYWIENIA */
    textarea.nutrition-additives {
        border: none !important;
        background: transparent !important;
        color: #000 !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 7px !important;
        line-height: 1.15 !important;
        min-height: auto !important;
        max-height: none !important;
        height: auto !important;
        width: 100% !important;
        overflow: visible !important;
        resize: none !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        display: block !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: normal !important;
        overflow-wrap: break-word !important;
    }
    
    /* Ukryj placeholdery na wydruku */
    input::-webkit-input-placeholder, textarea::-webkit-input-placeholder { color: transparent !important; }
    input::-moz-placeholder, textarea::-moz-placeholder { color: transparent !important; }
    input:-ms-input-placeholder, textarea:-ms-input-placeholder { color: transparent !important; }
    input::placeholder, textarea::placeholder { color: transparent !important; }
    
    .drug-name {
        font-weight: 500 !important;
    }

    /* Podpisy kompaktowe */
    .signature-box-cell,
    .sig,
    .signature-line {
        border: 0.5px solid #000 !important;
        border-radius: 0 !important;
        background: #fff !important;
        min-height: 20px !important;
    }

    /* GFR */
    tr.gfr-dose-adjusted td { 
        background: #f0f0f0 !important; 
    }
    .dose-reduction-notice { 
        color: #000 !important; 
        font-weight: 700 !important; 
        font-size: 6px !important;
    }

    /* Podsumowania kompaktowe */
    .controls-summary-container {
        margin-top: 1mm !important;
        page-break-inside: avoid !important;
    }
    .summary-container,
    #fluidBalanceSummary,
    #kcalSummary {
        color: #000 !important;
        font-size: 8px !important;
    }
    
    /* Stopka ultra kompaktowa */
    .footer-grid {
        grid-template-columns: 2.5fr 1fr !important;
        gap: 2mm !important;
        align-items: stretch !important;
        margin-top: 2mm !important;
        page-break-inside: avoid !important;
    }
    .notes-section textarea,
    .notes,
    textarea {
        border: 0.5px solid #000 !important;
        min-height: 35px !important;
        max-height: 45px !important;
        padding: 1.5mm !important;
        resize: none !important;
        background: #fff !important;
        color: #000 !important;
        font-size: 8px !important;
    }
    .signature-box {
        padding-top: 1mm !important;
    }
    .signature-line {
        min-height: 25px !important;
    }
    .signature-label { 
        color: #000 !important; 
        font-size: 8px !important;
    }
    .signature-sublabel { 
        color: #000 !important;
        font-size: 7px !important; 
    }

    /* Zapobieganie dzieleniu sekcji między strony */
    .header-section,
    .patient-card,
    .footer-grid {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
    }
    
    .section-header {
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    table {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
    }
}
    </style>
</head>
<body>
    <div class="top-controls no-print">
        <button onclick="window.print()" class="control-button print"><i class="fas fa-print"></i> Drukuj</button>
        <button onclick="generatePDF()" class="control-button pdf"><i class="fas fa-file-pdf"></i> PDF</button>
        <button onclick="saveCard()" class="control-button save"><i class="fas fa-save"></i> Zapisz w przeglądarce</button>
        <button onclick="openLoadModal()" class="control-button load"><i class="fas fa-folder-open"></i> Wczytaj z przeglądarki</button>
        <button onclick="saveCardToFile()" class="control-button save-file"><i class="fas fa-file-download"></i> Zapisz do pliku</button>
        <button onclick="document.getElementById('fileInput').click()" class="control-button load-file"><i class="fas fa-file-upload"></i> Wczytaj z pliku</button>
        <input type="file" id="fileInput" style="display: none;" onchange="loadCardFromFile(event)" accept=".json">
        <button onclick="clearCard()" class="control-button clear"><i class="fas fa-trash"></i> Wyczyść</button>
        <button id="darkModeToggle" class="control-button dark-mode"><i class="fas fa-moon"></i></button>
    </div>

    <div class="container" id="card-container">
        <div class="header-section">
            <div class="hospital-header">
                <div class="hospital-logo">
                    <div class="logo-icon">🏥</div>
                    <div>
                        <div style="font-size: 13px; font-weight: 600;">Szpital Zakonu Bonifratrów św. Jana Bożego w Łodzi</div>
                        <div style="font-size: 10px; opacity: 0.9;">ul. Kosynierów Gdyńskich 61, 93-357 Łódź</div>
                    </div>
                </div>
                <div class="header-right-info">
                    <div class="field-group">
                        <span class="field-label">Data</span>
                        <input type="text" id="mainDateInput" class="field-value small header-input" autocomplete="off" onchange="calculateIcuDay()"/>
                    </div>
                    <div class="field-group">
                        <span class="field-label">Doba w OIT</span>
                        <input type="number" min="0" id="icuDayInput" class="field-value small header-input" autocomplete="off"/>
                    </div>
                    <div class="field-group print-only-room" style="display:none;">
                        <span class="field-label">Sala/Łóżko</span>
                        <input type="text" id="roomInputPrint" class="field-value small header-input" autocomplete="off" readonly/>
                    </div>
                </div>
            </div>
            <h1>Oddział Anestezjologii i Intensywnej Terapii - Karta Zleceń Lekarskich</h1>
        </div>

        <div class="patient-card">
            <div class="patient-grid">
                <div class="field-group" style="grid-column: span 2;">
                    <span class="field-label">Imię i Nazwisko</span>
                    <input type="text" id="patientNameInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">PESEL</span>
                    <input type="text" id="peselInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Nr Historii</span>
                    <input type="text" id="historyNumberInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Data przyjęcia</span>
                    <input type="text" placeholder="DD.MM.RRRR" id="admissionDateInput" class="field-value header-input" autocomplete="off" onchange="calculateIcuDay()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Waga (kg)</span>
                    <input type="number" id="patientWeight" class="field-value header-input" autocomplete="off" oninput="handleWeightHeightChange()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Wzrost (cm)</span>
                    <input type="number" id="heightInput" class="field-value header-input" autocomplete="off" oninput="handleWeightHeightChange()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">BMI</span>
                    <input type="text" id="bmiOutput" class="field-value header-input" autocomplete="off" readonly/>
                </div>
                <div class="field-group" style="grid-column: span 2;">
                    <span class="field-label">Rozpoznanie</span>
                    <input type="text" id="diagnosisInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">GFR (ml/min)</span>
                    <input type="number" id="gfrInput" class="field-value gfr-input header-input" autocomplete="off" oninput="adjustAllDosesForGfr()"/>
                </div>
                 <div class="field-group">
                    <span class="field-label">Sala/Łóżko</span>
                    <input type="text" id="roomInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group" style="grid-column: span 4;">
                    <span class="field-label">⚠️ ALERGIE / NIETOLERANCJE</span>
                    <input type="text" id="allergiesInput" class="field-value alert-field header-input" autocomplete="off"/>
                </div>
            </div>
        </div>

        <div class="section-header">LEKI CIĄGŁE - POMPY INFUZYJNE</div>
        <table id="continuousDrugsTable">
            <thead>
                <tr>
                    <th style="width: 35%;">Lek / Stężenie</th>
                    <th style="width: 25%;">Dawka</th>
                    <th style="width: 15%;">Prędkość [ml/h]</th>
                    <th style="width: 25%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="continuousDrugsTbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addContinuousDrug()" class="add-button"><i class="fas fa-plus-circle"></i> Dodaj lek ciągły</button>
        </div>

        <div class="section-header green">LEKI OKRESOWE</div>
        <table id="periodicDrugsTable">
            <thead>
                <tr>
                    <th style="width: 30%;">Lek / Dawka</th>
                    <th style="width: 15%;">Droga / Częstość</th>
                    <th style="width: 55%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="periodicDrugsTbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addPeriodicDrug()" class="add-button green"><i class="fas fa-plus-circle"></i> Dodaj lek okresowy</button>
        </div>

        <div class="section-header cyan">PŁYNOTERAPIA I ŻYWIENIE</div>
        <table id="fluidsTable">
             <thead>
                <tr>
                    <th style="width: 20%;">Płyn</th>
                    <th style="width: 35%;">Dodatki</th>
                    <th style="width: 10%;">Objętość [ml]</th>
                    <th style="width: 10%;">Prędkość [ml/h]</th>
                    <th style="width: 25%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <table id="nutritionTable">
            <thead>
                <tr>
                    <th style="width: 25%;">Typ żywienia</th>
                    <th style="width: 35%;">Preparat / Dawka</th>
                    <th style="width: 15%;">Prędkość [ml/h]</th>
                    <th style="width: 25%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="controls-summary-container">
             <div class="button-container no-print">
                <button onclick="addFluid()" class="add-button cyan"><i class="fas fa-plus-circle"></i> Dodaj płyn</button>
                <button onclick="addNutrition()" class="add-button orange"><i class="fas fa-plus-circle"></i> Dodaj żywienie</button>
            </div>
            <div class="summary-container">
                <div id="fluidBalanceSummary">Suma płynów / 24h: <strong><span id="totalFluids">0</span> ml</strong></div>
                <div id="kcalSummary">Suma kcal / 24h: <strong><span id="totalKcal">0</span> kcal</strong></div>
            </div>
        </div>

        <div class="section-header purple">PROCEDURY / ZABIEGI</div>
        <table id="proceduresTable">
            <thead>
                <tr>
                    <th style="width: 15%;">Godzina</th>
                    <th style="width: 50%;">Procedura</th>
                    <th style="width: 35%;">Wykonano (podpis)</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addProcedure()" class="add-button purple"><i class="fas fa-plus-circle"></i> Dodaj procedurę</button>
        </div>

        <div class="section-header gray">UWAGI DODATKOWE / ZALECENIA</div>
        <div class="footer-grid">
            <div class="notes-section">
                <textarea placeholder="Miejsce na dodatkowe zalecenia, uwagi, konsultacje..." autocomplete="off"></textarea>
            </div>
            <div class="signature-box">
                <div class="signature-line"></div>
                <div class="signature-label">LEKARZ DYŻURNY</div>
                <div class="signature-sublabel">(pieczątka i podpis)</div>
            </div>
        </div>
    </div>

    <div id="loadCardModal" class="modal no-print" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Wczytaj zapisaną kartę</h3>
                <span class="close" onclick="closeModal('loadCardModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>Wybierz pacjenta z listy, aby wczytać jego kartę.</p>
                <ul id="savedCardsList"></ul>
            </div>
        </div>
    </div>

    <!-- DATALIST z prawidłowo sformatowanymi opcjami -->
    <datalist id="continuousDrugsList"></datalist>
    <datalist id="periodicDrugsList"></datalist>
    <datalist id="fluidsList"></datalist>
    <datalist id="enteralProductsList"></datalist>
    <datalist id="parenteralProductsList"></datalist>
    <datalist id="nutritionTypesList">
        <option value="Żywienie dojelitowe"></option>
        <option value="Żywienie pozajelitowe"></option>
        <option value="Dieta doustna"></option>
    </datalist>
    <datalist id="proceduresList">
        <option value="Toaleta drzewa oskrzelowego"></option>
        <option value="RTG klatki piersiowej przyłóżkowe"></option>
        <option value="Zmiana opatrunku CVC"></option>
        <option value="Zmiana pozycji ciała"></option>
        <option value="Profilaktyka odleżyn"></option>
        <option value="USG płuc"></option>
        <option value="USG jamy brzusznej"></option>
        <option value="Bronchoskopia"></option>
        <option value="Wymiana rurki intubacyjnej"></option>
        <option value="Wymiana rurki tracheostomijnej"></option>
        <option value="Założenie CVC"></option>
        <option value="Założenie cewnika tętniczego"></option>
        <option value="Założenie cewnika Foleya"></option>
        <option value="Punkcja lędźwiowa"></option>
        <option value="Nakłucie jamy opłucnej"></option>
        <option value="Drenaż jamy opłucnej"></option>
        <option value="CRRT - rozpoczęcie"></option>
        <option value="CRRT - wymiana zestawu"></option>
        <option value="Hemodializa"></option>
        <option value="Plazmafereza"></option>
        <option value="Fizjoterapia"></option>
        <option value="Rehabilitacja oddechowa"></option>
        <option value="Pionizacja"></option>
        <option value="EKG"></option>
        <option value="ECHO serca"></option>
        <option value="Gastroskopia"></option>
        <option value="Kolonoskopia"></option>
        <option value="CT głowy"></option>
        <option value="CT klatki piersiowej"></option>
        <option value="CT jamy brzusznej"></option>
    </datalist>
    <datalist id="timesList">
        <option value="06:00"></option>
        <option value="07:00"></option>
        <option value="08:00"></option>
        <option value="09:00"></option>
        <option value="10:00"></option>
        <option value="11:00"></option>
        <option value="12:00"></option>
        <option value="13:00"></option>
        <option value="14:00"></option>
        <option value="15:00"></option>
        <option value="16:00"></option>
        <option value="17:00"></option>
        <option value="18:00"></option>
        <option value="19:00"></option>
        <option value="20:00"></option>
        <option value="21:00"></option>
        <option value="22:00"></option>
        <option value="23:00"></option>
        <option value="00:00"></option>
        <option value="01:00"></option>
        <option value="02:00"></option>
        <option value="03:00"></option>
        <option value="04:00"></option>
        <option value="05:00"></option>
        <option value="co 1h"></option>
        <option value="co 2h"></option>
        <option value="co 4h"></option>
        <option value="co 6h"></option>
        <option value="co 8h"></option>
        <option value="co 12h"></option>
        <option value="co 24h"></option>
        <option value="doraźnie"></option>
    </datalist>
    
    <script>
// --- ENHANCED MEDICAL CARD SYSTEM ---

// --- BAZY DANYCH I KONFIGURACJA ---
const continuousDrugsData = { 'NORADRENALINA': { concentration: '8mg/50ml', dose: '0.1-1.0 μg/kg/min' }, 'ADRENALINA': { concentration: '1mg/50ml', dose: '0.01-0.1 μg/kg/min' }, 'DOPAMINA': { concentration: '200mg/50ml', dose: '2-20 μg/kg/min' }, 'DOBUTAMINA': { concentration: '250mg/50ml', dose: '2-20 μg/kg/min' }, 'WAZOPRESYNA': { concentration: '20j/20ml', dose: '0.01-0.04 j/min' }, 'MILRINON': { concentration: '10mg/50ml', dose: '0.375-0.75 μg/kg/min' }, 'PROPOFOL 1%': { concentration: '10mg/ml', dose: '1-4 mg/kg/h' }, 'PROPOFOL 2%': { concentration: '20mg/ml', dose: '1-4 mg/kg/h' }, 'MIDAZOLAM': { concentration: '50mg/50ml', dose: '1-15 mg/h' }, 'DEKSMEDETOMIDYNA': { concentration: '200μg/50ml', dose: '0.2-1.4 μg/kg/h' }, 'FENTANYL': { concentration: '500μg/50ml', dose: '25-100 μg/h' }, 'REMIFENTANYL': { concentration: '2mg/40ml', dose: '0.05-0.2 μg/kg/min' }, 'MORFINA': { concentration: '20mg/20ml', dose: '1-5 mg/h' }, 'LIGNOCAINA 1%': { concentration: '500mg/50ml', dose: '1-2 mg/min' }, 'OKSYKODON': { concentration: '20mg/20ml', dose: '1-2 mg/h' }, 'KETAMINA': { concentration: '250mg/50ml', dose: '0.5-2 mg/kg/h' }, 'ROKURONIOM': { concentration: '50mg/5ml', dose: '0.3-0.6 mg/kg/h' }, 'CISATRAKURIUM': { concentration: '20mg/10ml', dose: '0.06-0.18 mg/kg/h' }, 'INSULINA': { concentration: '50j/50ml', dose: '0.5-10 j/h' }, 'HEPARYNA': { concentration: '25000j/50ml', dose: '500-2000 j/h' }, 'FUROSEMID': { concentration: '100mg/50ml', dose: '5-20 mg/h' }, 'AMIODARON': { concentration: '300mg/50ml 5% Glc', dose: '20-50 mg/h' }, 'NITROGLICERYNA': { concentration: '25mg/50ml', dose: '5-200 μg/min' }, 'PIPERACYLINA/TAZOBAKTAM': { concentration: '18g/100ml', dose: 'wlew 24h', fixedRate: '4.2' }, 'PANTOPRAZOL': { concentration: '80mg/100ml', dose: '4.2 ml/h', fixedRate: '4.2' }, 'METOPROLOL': { concentration: '10mg/50ml', dose: '1-5 mg/h' }, 'SALBUTAMOL': { concentration: '5mg/50ml', dose: '3-20 μg/min' }, 'DIAZEPAM': { concentration: '50mg/50ml', dose: '2-10 mg/h' } };

const periodicDrugsData = { 'AMOKSYCYLINA/KWAS KLAWULANOWY': { dose: '1.2g', route: 'i.v.', frequency: 'co 8h' }, 'AMIKACYNA': { dose: '15-20mg/kg', route: 'wlew i.v. 1h', frequency: 'co 24h' }, 'CEFTAZYDYM': { dose: '2g', route: 'i.v.', frequency: 'co 8h' }, 'CEFUROKSYM': { dose: '1.5g', route: 'i.v.', frequency: 'co 8h' }, 'CIPROFLOKSACYNA': { dose: '400mg', route: 'wlew i.v. 1h', frequency: 'co 12h' }, 'IMIPENEM/CYLASTATYNA': { dose: '0.5g', route: 'wlew i.v. 30min', frequency: 'co 6-8h' }, 'KOLISTYNA': { dose: 'nasyc. 9mln j, potem 4.5mln j', route: 'i.v.', frequency: 'co 12h' }, 'LEWOFLOKSACYNA': { dose: '500mg', route: 'wlew i.v. 1h', frequency: 'co 24h' }, 'LINEZOLID': { dose: '600mg', route: 'wlew i.v. 2h', frequency: 'co 12h' }, 'MEROPENEM': { dose: '1g', route: 'wlew i.v. 30min', frequency: 'co 8h' }, 'METRONIDAZOL': { dose: '500mg', route: 'i.v.', frequency: 'co 8h' }, 'PIPERACYLINA/TAZOBAKTAM': { dose: '4.5g', route: 'wlew i.v. 30min', frequency: 'co 8h' }, 'SULBAKTAM/CEFOPERAZON': { dose: '2g', route: 'i.v.', frequency: 'co 12h' }, 'TEIKOPLANINA': { dose: 'nasyc. 400mg x3 co 12h, potem 400mg', route: 'i.v.', frequency: 'co 24h' }, 'TYGECYKLINA': { dose: 'nasyc. 100mg, potem 50mg', route: 'wlew i.v. 1h', frequency: 'co 12h' }, 'WANKOMYCYNA': { dose: '1g', route: 'wlew i.v. 1h', frequency: 'co 12h' }, 'FLUKONAZOL': { dose: '400mg', route: 'i.v.', frequency: 'co 24h' }, 'WORYKONAZOL': { dose: 'nasyc. 6mg/kg x2, potem 4mg/kg', route: 'wlew i.v. 2h', frequency: 'co 12h' }, 'GENTAMYCYNA': { dose: '3-5mg/kg', route: 'wlew i.v. 1h', frequency: 'co 24h' }, 'KETOKONAZOL': { dose: '200mg', route: 'p.o. (sonda)', frequency: 'co 12h' }, 'FUROSEMID': { dose: '20-40mg', route: 'i.v.', frequency: 'wg zlecenia' }, 'MANNITOL 15%': { dose: '100ml', route: 'wlew i.v. 30min', frequency: 'wg zlecenia' }, 'SPIRONOLAKTON': { dose: '25-100mg', route: 'i.v.', frequency: 'co 24h' }, 'ENOKSAPARYNA': { dose: '40mg', route: 's.c.', frequency: 'co 24h' }, 'NADROPARYNA': { dose: '0.4-0.6ml', route: 's.c.', frequency: 'co 24h' }, 'KWAS TRANEXAMOWY': { dose: '1g', route: 'i.v.', frequency: 'co 8h' }, 'ETAMSYLAT': { dose: '250-500mg', route: 'i.v.', frequency: 'co 6h' }, 'DEKSAMETAZON': { dose: '4-8mg', route: 'i.v.', frequency: 'co 6-12h' }, 'HYDROKORTYZON': { dose: '50-100mg', route: 'i.v.', frequency: 'co 6-8h' }, 'METYLOPREDNIZOLON': { dose: '125mg', route: 'i.v.', frequency: 'wg zlecenia' }, 'METAMIZOL': { dose: '1g', route: 'i.v.', frequency: 'co 6-8h' }, 'PARACETAMOL': { dose: '1g', route: 'i.v.', frequency: 'co 6h' }, 'METOKLOPRAMID': { dose: '10mg', route: 'i.v.', frequency: 'co 8h' }, 'PANTOPRAZOL': { dose: '40mg', route: 'i.v.', frequency: 'co 24h' }, 'OMEPRAZOL': { dose: '40mg', route: 'i.v.', frequency: 'co 24h' }, 'HALOPERIDOL': { dose: '2.5-5mg', route: 'i.v./i.m.', frequency: 'wg zlecenia' }, 'CHLORPROMAZYNA': { dose: '25-50mg', route: 'i.m.', frequency: 'doraźnie' }, 'DESMOPRESYNA': { dose: '1-4μg', route: 'i.v./s.c.', frequency: 'co 12-24h' }, 'WAPŃ': { dose: '10-20ml 10%', route: 'i.v. wlew', frequency: 'co 6h' }, 'WINPOCETYNA': { dose: '10mg', route: 'i.v. wlew', frequency: 'co 12h' }, 'CEREBROLIZYNA': { dose: '10-30ml', route: 'i.v. wlew', frequency: 'co 24h' }, 'PIRACETAM': { dose: '4.8g', route: 'i.v.', frequency: 'co 12h' }, 'ORNITYNA': { dose: '20g', route: 'i.v. wlew 24h', frequency: 'co 24h' }, 'CYKLOFOSFAMID': { dose: 'wg zlecenia', route: 'i.v. wlew', frequency: 'wg schematu' }, 'ACETYLOCYSTEINA': { dose: '300mg (3ml)', route: 'nebulizacja', frequency: 'co 8h' }, 'ADRENALINA (NEBULIZACJA)': { dose: '0.5mg', route: 'nebulizacja', frequency: 'wg zlecenia' }, 'AMBROKSOL': { dose: '15mg (2ml)', route: 'nebulizacja', frequency: 'co 12h' }, 'BERODUAL': { dose: '1-2ml (20-40 kropli)', route: 'nebulizacja', frequency: 'co 4-6h' }, 'IPRATROPIUM': { dose: '0.5mg (2ml)', route: 'nebulizacja', frequency: 'co 6-8h' }, 'KOLISTYNA (NEBULIZACJA)': { dose: '1-2mln j', route: 'nebulizacja', frequency: 'co 8-12h' }, 'SALBUTAMOL (NEBULIZACJA)': { dose: '2.5mg', route: 'nebulizacja', frequency: 'co 4-6h' }, 'SALBUTAMOL (WZIEW)': { dose: '2 wdechy', route: 'do rurki', frequency: 'co 4h' }, 'NABIC (1.4% NAHCO3)': { dose: '5ml', route: 'nebulizacja', frequency: 'co 8h' }, 'LEWOFLOKSACYNA (KROPLE)': { dose: '1 kropla', route: 'do worka spoj.', frequency: 'co 2h → co 6h' }, 'TOBRAMYCYNA/DEKSAMETAZON (KROPLE)': { dose: '1 kropla', route: 'do worka spoj.', frequency: 'co 6h' }, 'OFLOKSACYNA (KROPLE)': { dose: '1 kropla', route: 'do worka spoj.', frequency: 'co 6h' }, 'POLPRAZOL': { dose: '20mg', route: 'p.o. (sonda)', frequency: 'co 12h' }, 'LACTULOSUM': { dose: '15ml', route: 'p.o. (sonda)', frequency: 'co 8h' }, 'KALIUM POLISTYRENOSULFONIAN': { dose: '15g (1 miarka)', route: 'p.o. (sonda)', frequency: 'co 6-8h' }, 'EUTHYROX': { dose: 'wg zlecenia', route: 'p.o. na czczo', frequency: 'co 24h' } };

const fluidsData = { 'NaCl 0.9%': { volume: '500ml', rate: '50' }, 'Plasmalyte': { volume: '500ml', rate: '50' }, 'Optilyte': { volume: '500ml', rate: '50' }, 'Płyn Ringera': { volume: '500ml', rate: '50' }, 'Glukoza 5%': { volume: '500ml', rate: '40' }, 'Glukoza 10%': { volume: '500ml', rate: '30' }, 'Gelofusine': { volume: '500ml', rate: '100' }, 'Albuminy 20%': { volume: '100ml', rate: '50' }, 'Albuminy 5%': { volume: '250ml', rate: '100' }, 'Mannitol 15%': { volume: '250ml', rate: '125' }, 'NaHCO3 8.4%': { volume: '100ml', rate: '50' } };

const glucoseKcalData = { "Glukoza 5%": 0.17, "Glukoza 10%": 0.34 };

const nutritionFlowRates = {
    "Nutricomp Standard 500ml (1 kcal/ml)": 50, "Nutricomp Standard 1000ml (1 kcal/ml)": 80, 
    "Nutricomp intensiv 500ml (1.5 kcal/ml)": 40, "Nutricomp intensiv 1000ml (1.5 kcal/ml)": 60,
    "Nutricomp Standard Fibre 500ml (1 kcal/ml)": 50, "Nutrison 500ml (1 kcal/ml)": 50, 
    "Nutrison 1000ml (1 kcal/ml)": 80, "Nutrison 1500ml (1 kcal/ml)": 100, 
    "Nutrison Advanced Peptisorb 500ml (1 kcal/ml)": 50, "Nutrison Advanced Peptisorb 1000ml (1 kcal/ml)": 80,
    "Nutrison Multi Fibre 500ml (1 kcal/ml)": 50, "Nutrison Multi Fibre 1000ml (1 kcal/ml)": 80,
    "OMEGAFLEX PLUS 1250ml (1.3 kcal/ml)": 50, "OMEGAFLEX PLUS 1875ml (1.3 kcal/ml)": 75,
    "OMEGAFLEX SPECIAL 625ml (1.3 kcal/ml)": 25, "OMEGAFLEX SPECIAL 1250ml (1.3 kcal/ml)": 50, 
    "OMEGAFLEX SPECIAL 1875ml (1.3 kcal/ml)": 75, "Nutriflex Peri 1000ml (1.2 kcal/ml)": 80,
    "Nutriflex Plus 1000ml (1.2 kcal/ml)": 80, "SmofKabiven 986ml (1.1 kcal/ml)": 40, 
    "SmofKabiven 1477ml (1.1 kcal/ml)": 60, "SmofKabiven Extra NITROGEN 1012ml (1.2 kcal/ml)": 42,
    "SmofKabiven Extra NITROGEN 1518ml (1.2 kcal/ml)": 63, "SmofKabiven EF 986ml (1.1 kcal/ml)": 40,
    "SmofKabiven EF 1477ml (1.1 kcal/ml)": 60, "SmofKabiven LOW OSMO 850ml (1.0 kcal/ml)": 35,
    "SmofKabiven LOW OSMO 1400ml (1.0 kcal/ml)": 58, "SmofKabiven LOW OSMO 1950ml (1.0 kcal/ml)": 81,
    "Aminomix 1 Novum 1000ml (0.8 kcal/ml)": 80, "Aminomix 1 Novum 1500ml (0.8 kcal/ml)": 100
};

const nutritionData = { 
    "Nutricomp Standard 500ml (1 kcal/ml)": { kcal: 500, volume: 500 }, 
    "Nutricomp Standard 1000ml (1 kcal/ml)": { kcal: 1000, volume: 1000 },
    "Nutricomp intensiv 500ml (1.5 kcal/ml)": { kcal: 750, volume: 500 }, 
    "Nutricomp intensiv 1000ml (1.5 kcal/ml)": { kcal: 1500, volume: 1000 },
    "Nutricomp Standard Fibre 500ml (1 kcal/ml)": { kcal: 500, volume: 500 }, 
    "Nutrison 500ml (1 kcal/ml)": { kcal: 500, volume: 500 }, 
    "Nutrison 1000ml (1 kcal/ml)": { kcal: 1000, volume: 1000 }, 
    "Nutrison 1500ml (1 kcal/ml)": { kcal: 1500, volume: 1500 },
    "Nutrison Advanced Peptisorb 500ml (1 kcal/ml)": { kcal: 500, volume: 500 }, 
    "Nutrison Advanced Peptisorb 1000ml (1 kcal/ml)": { kcal: 1000, volume: 1000 },
    "Nutrison Multi Fibre 500ml (1 kcal/ml)": { kcal: 500, volume: 500 }, 
    "Nutrison Multi Fibre 1000ml (1 kcal/ml)": { kcal: 1000, volume: 1000 },
    "OMEGAFLEX PLUS 1250ml (1.3 kcal/ml)": { kcal: 1625, volume: 1250 }, 
    "OMEGAFLEX PLUS 1875ml (1.3 kcal/ml)": { kcal: 2438, volume: 1875 },
    "OMEGAFLEX SPECIAL 625ml (1.3 kcal/ml)": { kcal: 813, volume: 625 }, 
    "OMEGAFLEX SPECIAL 1250ml (1.3 kcal/ml)": { kcal: 1625, volume: 1250 }, 
    "OMEGAFLEX SPECIAL 1875ml (1.3 kcal/ml)": { kcal: 2438, volume: 1875 },
    "Nutriflex Peri 1000ml (1.2 kcal/ml)": { kcal: 1200, volume: 1000 }, 
    "Nutriflex Plus 1000ml (1.2 kcal/ml)": { kcal: 1200, volume: 1000 },
    "SmofKabiven 986ml (1.1 kcal/ml)": { kcal: 1085, volume: 986 }, 
    "SmofKabiven 1477ml (1.1 kcal/ml)": { kcal: 1625, volume: 1477 },
    "SmofKabiven Extra NITROGEN 1012ml (1.2 kcal/ml)": { kcal: 1214, volume: 1012 }, 
    "SmofKabiven Extra NITROGEN 1518ml (1.2 kcal/ml)": { kcal: 1822, volume: 1518 },
    "SmofKabiven EF 986ml (1.1 kcal/ml)": { kcal: 1085, volume: 986 }, 
    "SmofKabiven EF 1477ml (1.1 kcal/ml)": { kcal: 1625, volume: 1477 },
    "SmofKabiven LOW OSMO 850ml (1.0 kcal/ml)": { kcal: 850, volume: 850 }, 
    "SmofKabiven LOW OSMO 1400ml (1.0 kcal/ml)": { kcal: 1400, volume: 1400 }, 
    "SmofKabiven LOW OSMO 1950ml (1.0 kcal/ml)": { kcal: 1950, volume: 1950 },
    "Aminomix 1 Novum 1000ml (0.8 kcal/ml)": { kcal: 800, volume: 1000 }, 
    "Aminomix 1 Novum 1500ml (0.8 kcal/ml)": { kcal: 1200, volume: 1500 }
};

const gfrDoseAdjustments = {
    'WANKOMYCYNA': [
        { gfrMax: 10, dose: '1g nasyc., potem 0.5g', frequency: 'co 72h + TDM' },
        { gfrMax: 50, dose: '1g', frequency: 'co 48h + TDM' }
    ],
    'MEROPENEM': [
        { gfrMax: 10, dose: '0.5g', frequency: 'co 24h' },
        { gfrMax: 25, dose: '0.5g', frequency: 'co 12h' },
        { gfrMax: 50, dose: '1g', frequency: 'co 12h' }
    ],
    'PIPERACYLINA/TAZOBAKTAM': [
        { gfrMax: 20, dose: '2.25g', frequency: 'co 8h' },
        { gfrMax: 40, dose: '3.375g', frequency: 'co 8h' }
    ],
    'AMIKACYNA': [
        { gfrMax: 10, dose: '7.5mg/kg', frequency: 'co 72h + TDM' },
        { gfrMax: 50, dose: '15mg/kg', frequency: 'co 36h + TDM' }
    ],
    'GENTAMYCYNA': [
        { gfrMax: 10, dose: '1-2mg/kg', frequency: 'co 72h + TDM' },
        { gfrMax: 50, dose: '3-5mg/kg', frequency: 'co 36h + TDM' }
    ],
    'LEWOFLOKSACYNA': [
        { gfrMax: 50, dose: '500mg x1, potem 250mg', frequency: 'co 48h' }
    ],
    'FLUKONAZOL': [
        { gfrMax: 50, dose: 'nasyc. 400mg, potem 200mg', frequency: 'co 24h' }
    ],
    'ENOKSAPARYNA': [
        { gfrMax: 15, dose: 'Przeciwwskazana', frequency: ''},
        { gfrMax: 30, dose: '20mg', frequency: 'co 24h' }
    ]
};

// SZABLONY KART
const cardTemplates = {
    'postop-cardiac': {
        title: '🫀 Kardiochirurgia (Post-op)',
        description: 'Typowy zestaw leków po operacjach kardiochirurgicznych',
        diagnosis: 'Stan po operacji kardiochirurgicznej',
        continuousDrugs: [
            { name: 'NORADRENALINA', conc: '8mg/50ml', dose: '0.1-0.5 μg/kg/min', rate: '' },
            { name: 'PROPOFOL 1%', conc: '10mg/ml', dose: '1-3 mg/kg/h', rate: '' },
            { name: 'FENTANYL', conc: '500μg/50ml', dose: '50-100 μg/h', rate: '' }
        ],
        periodicDrugs: [
            { name: 'PARACETAMOL', dose: '1g', route: 'i.v.', freq: 'co 6h' },
            { name: 'PANTOPRAZOL', dose: '40mg', route: 'i.v.', freq: 'co 24h' },
            { name: 'ENOKSAPARYNA', dose: '40mg', route: 's.c.', freq: 'co 24h' }
        ],
        fluids: [
            { name: 'Plasmalyte', additives: '', volume: '500', rate: '50' }
        ],
        procedures: [
            { time: '06:00', name: 'RTG klatki piersiowej przyłóżkowe' },
            { time: 'co 4h', name: 'Zmiana pozycji ciała' }
        ]
    },
    'sepsis': {
        title: '🦠 Sepsa / Wstrząs septyczny',
        description: 'Protokół leczenia sepsy z antybiotykami i wazopresornami',
        diagnosis: 'Sepsa / Wstrząs septyczny',
        continuousDrugs: [
            { name: 'NORADRENALINA', conc: '8mg/50ml', dose: '0.2-1.0 μg/kg/min', rate: '' },
            { name: 'WAZOPRESYNA', conc: '20j/20ml', dose: '0.01-0.04 j/min', rate: '' }
        ],
        periodicDrugs: [
            { name: 'MEROPENEM', dose: '1g', route: 'wlew i.v. 30min', freq: 'co 8h' },
            { name: 'WANKOMYCYNA', dose: '1g', route: 'wlew i.v. 1h', freq: 'co 12h' },
            { name: 'FLUKONAZOL', dose: '400mg', route: 'i.v.', freq: 'co 24h' },
            { name: 'HYDROKORTYZON', dose: '50mg', route: 'i.v.', freq: 'co 6h' }
        ],
        fluids: [
            { name: 'Plasmalyte', additives: '', volume: '500', rate: '100' },
            { name: 'Albuminy 5%', additives: '', volume: '250', rate: '100' }
        ]
    },
    'trauma': {
        title: '🚨 Uraz wielonarządowy',
        description: 'Leczenie po ciężkim urazie z sedacją i analgezją',
        diagnosis: 'Uraz wielonarządowy',
        continuousDrugs: [
            { name: 'PROPOFOL 1%', conc: '10mg/ml', dose: '2-4 mg/kg/h', rate: '' },
            { name: 'FENTANYL', conc: '500μg/50ml', dose: '75-150 μg/h', rate: '' },
            { name: 'CISATRAKURIUM', conc: '20mg/10ml', dose: '0.06-0.18 mg/kg/h', rate: '' }
        ],
        periodicDrugs: [
            { name: 'AMOKSYCYLINA/KWAS KLAWULANOWY', dose: '1.2g', route: 'i.v.', freq: 'co 8h' },
            { name: 'METAMIZOL', dose: '1g', route: 'i.v.', freq: 'co 6h' },
            { name: 'PANTOPRAZOL', dose: '40mg', route: 'i.v.', freq: 'co 24h' }
        ],
        fluids: [
            { name: 'Plasmalyte', additives: '', volume: '500', rate: '75' }
        ]
    },
    'respiratory': {
        title: '🫁 Niewydolność oddechowa',
        description: 'Leczenie wspomagające w niewydolności oddechowej',
        diagnosis: 'Ostra niewydolność oddechowa',
        continuousDrugs: [
            { name: 'DEKSMEDETOMIDYNA', conc: '200μg/50ml', dose: '0.2-1.0 μg/kg/h', rate: '' },
            { name: 'SALBUTAMOL', conc: '5mg/50ml', dose: '5-15 μg/min', rate: '' }
        ],
        periodicDrugs: [
            { name: 'DEKSAMETAZON', dose: '8mg', route: 'i.v.', freq: 'co 12h' },
            { name: 'SALBUTAMOL (NEBULIZACJA)', dose: '2.5mg', route: 'nebulizacja', freq: 'co 4h' },
            { name: 'ACETYLOCYSTEINA', dose: '300mg (3ml)', route: 'nebulizacja', freq: 'co 8h' },
            { name: 'FUROSEMID', dose: '20mg', route: 'i.v.', freq: 'co 12h' }
        ],
        procedures: [
            { time: 'co 4h', name: 'Toaleta drzewa oskrzelowego' },
            { time: 'co 8h', name: 'Rehabilitacja oddechowa' }
        ]
    },
    'renal': {
        title: '🫘 Niewydolność nerek',
        description: 'Leczenie w niewydolności nerek z CRRT',
        diagnosis: 'Ostra niewydolność nerek',
        continuousDrugs: [
            { name: 'HEPARYNA', conc: '25000j/50ml', dose: '500-1000 j/h', rate: '' },
            { name: 'FUROSEMID', conc: '100mg/50ml', dose: '10-20 mg/h', rate: '' }
        ],
        periodicDrugs: [
            { name: 'MEROPENEM', dose: '0.5g', route: 'wlew i.v. 30min', freq: 'co 12h' },
            { name: 'WANKOMYCYNA', dose: '1g', route: 'wlew i.v. 1h', freq: 'co 48h + TDM' },
            { name: 'ENOKSAPARYNA', dose: '20mg', route: 's.c.', freq: 'co 24h' }
        ],
        procedures: [
            { time: '08:00', name: 'CRRT - rozpoczęcie' },
            { time: 'co 24h', name: 'CRRT - wymiana zestawu' }
        ],
        gfr: 15
    }
};

// GLOBALNE ZMIENNE
let autosaveInterval = null;
let hasUnsavedChanges = false;
let dragSortables = [];
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
let isOnline = navigator.onLine;

// --- TOAST NOTIFICATIONS SYSTEM ---
function showToast(title, message, type = 'info', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="fas ${icons[type]} toast-icon"></i>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="removeToast(this)">×</button>
    `;
    
    container.appendChild(toast);
    
    // Auto remove after duration
    setTimeout(() => {
        if (toast.parentNode) {
            removeToast(toast.querySelector('.toast-close'));
        }
    }, duration);
}

function removeToast(button) {
    const toast = button.parentElement;
    toast.style.animation = 'toastSlideIn 0.3s ease-out reverse';
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 300);
}

// --- AUTOSAVE SYSTEM ---
function updateAutosaveIndicator(status, message) {
    const indicator = document.getElementById('autosaveIndicator');
    indicator.className = `autosave-indicator ${status}`;
    indicator.querySelector('span').textContent = message;
    
    const icons = {
        saving: 'fa-circle',
        saved: 'fa-check-circle', 
        error: 'fa-exclamation-circle'
    };
    indicator.querySelector('i').className = `fas ${icons[status] || 'fa-circle'}`;
}

function markAsChanged() {
    hasUnsavedChanges = true;
    updateAutosaveIndicator('saving', 'Zapisywanie...');
}

function autoSave() {
    if (!hasUnsavedChanges) return;
    
    const patientName = document.getElementById('patientNameInput').value.trim();
    if (!patientName) {
        updateAutosaveIndicator('error', 'Brak nazwy pacjenta');
        return;
    }
    
    try {
        const cardState = getCardState();
        const autoSaveKey = `autosave_${patientName.replace(/\s+/g, '-')}`;
        localStorage.setItem(autoSaveKey, JSON.stringify({
            ...cardState,
            timestamp: new Date().toISOString(),
            isAutoSave: true
        }));
        
        hasUnsavedChanges = false;
        updateAutosaveIndicator('saved', 'Wszystkie zmiany zapisane');
        
    } catch (e) {
        updateAutosaveIndicator('error', 'Błąd zapisu automatycznego');
        console.error('Autosave error:', e);
    }
}

function startAutosave() {
    if (autosaveInterval) clearInterval(autosaveInterval);
    autosaveInterval = setInterval(autoSave, 30000); // co 30 sekund
}

function restoreFromAutosave() {
    const patientName = document.getElementById('patientNameInput').value.trim();
    if (!patientName) return;
    
    const autoSaveKey = `autosave_${patientName.replace(/\s+/g, '-')}`;
    const savedData = localStorage.getItem(autoSaveKey);
    
    if (savedData) {
        try {
            const cardState = JSON.parse(savedData);
            if (cardState.isAutoSave) {
                const saveTime = new Date(cardState.timestamp).toLocaleString();
                if (confirm(`Znaleziono automatyczny zapis z ${saveTime}. Czy przywrócić dane?`)) {
                    populateCardFromState(cardState);
                    showToast('Przywrócono', 'Dane zostały przywrócone z automatycznego zapisu', 'success');
                }
            }
        } catch (e) {
            console.error('Error restoring autosave:', e);
        }
    }
}

// --- FUNKCJE POMOCNICZE ---
function autoResizeTextarea(textarea) {
    if (!textarea) return;
    textarea.style.height = 'auto'; // Resetuj wysokość
    textarea.style.height = (textarea.scrollHeight) + 'px'; // Ustaw wysokość na wysokość zawartości
}

// --- GŁÓWNE FUNKCJE ---
function removeRow(button) { 
    button.closest('tr').remove(); 
    updateSummaries(); 
}
function updateSummaries() { 
    let totalFluids = 0; 
    let totalKcal = 0; 
    
    // Płyny z tabeli fluids
    document.querySelectorAll('#fluidsTable tbody tr').forEach(row => { 
        const rateInput = row.querySelector('.fluid-rate'); 
        if (rateInput && rateInput.value) { 
            const rate = parseFloat(rateInput.value.replace(',', '.')); 
            if (!isNaN(rate)) { 
                totalFluids += rate * 24; 
            } 
        } 
        const nameInput = row.querySelector('.fluid-name'); 
        if(nameInput && glucoseKcalData[nameInput.value]) { 
            const rate = parseFloat(rateInput.value.replace(',', '.')); 
            if (!isNaN(rate)) { 
                totalKcal += (rate * 24) * glucoseKcalData[nameInput.value]; 
            } 
        } 
    }); 
    
    // Żywienie z tabeli nutrition
    document.querySelectorAll('#nutritionTable tbody tr').forEach(row => { 
        const prepInput = row.querySelector('.nutrition-prep'); 
        const rateInput = row.querySelector('.nutrition-rate');
        
        if (prepInput && prepInput.value && rateInput && rateInput.value) {
            const rate = parseFloat(rateInput.value.replace(',', '.'));
            const productInfo = nutritionData[prepInput.value];
            
            if (productInfo && !isNaN(rate) && rate > 0) {
                const hoursToInfuse = productInfo.volume / rate;
                const kcalPerHour = productInfo.kcal / hoursToInfuse;
                const fluidPerHour = rate;
                
                totalFluids += fluidPerHour * 24;
                totalKcal += kcalPerHour * 24;
            }
        } else if (prepInput && prepInput.value) {
            const productInfo = nutritionData[prepInput.value];
            if (productInfo) { 
                totalFluids += productInfo.volume; 
                totalKcal += productInfo.kcal; 
            } 
        }
    }); 
    
    document.getElementById('totalFluids').textContent = totalFluids.toFixed(0); 
    document.getElementById('totalKcal').textContent = totalKcal.toFixed(0); 
}
function calculateInfusionRate(inputElement) { const row = inputElement.closest('tr'); if (!row) return; const weightInput = document.getElementById('patientWeight'); const weight = parseFloat(weightInput.value); const doseInput = row.querySelector('.dose'); const concentrationInput = row.querySelector('input[id$="_conc"]'); const rateOutput = row.querySelector('.infusion-rate'); if (!weight || weight <= 0 || !doseInput.value || !concentrationInput.value) { return; } let doseStr = doseInput.value.replace(',', '.'); let concStr = concentrationInput.value.replace(',', '.'); const doseRegex = /([\d\.]+)(?:\s*-\s*([\d\.]+))?.*?(μg|mcg|mg|j)\s*(\/kg)?\s*\/(min|h)/; const doseMatch = doseStr.match(doseRegex); if (!doseMatch) { rateOutput.value = ''; return; } let doseValue1 = parseFloat(doseMatch[1]); let doseValue2 = doseMatch[2] ? parseFloat(doseMatch[2]) : null; let doseUnit = doseMatch[3]; const perKg = doseMatch[4]; const perTime = doseMatch[5]; const concRegex = /([\d\.]+)\s*(mg|μg|mcg|j)\s*\/(?:([\d\.]+)\s*)?ml/; const concMatch = concStr.match(concRegex); let concentrationPerMl; if (concMatch) { let totalMass = parseFloat(concMatch[1]); const massUnit = concMatch[2]; const totalVolume = concMatch[3] ? parseFloat(concMatch[3]) : 1; if (massUnit === 'mg') totalMass *= 1000; concentrationPerMl = totalMass / totalVolume; } else { rateOutput.value = ''; return; } if (concentrationPerMl === 0) return; if (doseUnit === 'mg') { doseValue1 *= 1000; if(doseValue2) doseValue2 *= 1000; } const calculateRate = (dose) => { let totalDosePerTime = dose; if (perKg) totalDosePerTime *= weight; const volumePerTime = totalDosePerTime / concentrationPerMl; return (perTime === 'min') ? volumePerTime * 60 : volumePerTime; }; const finalRate1 = calculateRate(doseValue1); if (doseValue2) { const finalRate2 = calculateRate(doseValue2); rateOutput.value = `${finalRate1.toFixed(1).replace('.', ',')} - ${finalRate2.toFixed(1).replace('.', ',')}`; } else { rateOutput.value = finalRate1.toFixed(1).replace('.', ','); } }
function calculateIcuDay() { const admissionDateStr = document.getElementById('admissionDateInput').value; const mainDateStr = document.getElementById('mainDateInput').value; const icuDayInput = document.getElementById('icuDayInput'); const parseDate = (dateStr) => { const parts = dateStr.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/); if (!parts) return null; return new Date(parts[3], parts[2] - 1, parts[1]); }; const admissionDate = parseDate(admissionDateStr); const mainDate = parseDate(mainDateStr); if (admissionDate && mainDate && mainDate >= admissionDate) { const utcMain = Date.UTC(mainDate.getFullYear(), mainDate.getMonth(), mainDate.getDate()); const utcAdmission = Date.UTC(admissionDate.getFullYear(), admissionDate.getMonth(), admissionDate.getDate()); const dayInMillis = 1000 * 60 * 60 * 24; const diffDays = (utcMain - utcAdmission) / dayInMillis; icuDayInput.value = Math.round(diffDays) + 1; } else { icuDayInput.value = ''; } }
function calculateBMI() { const weightInput = document.getElementById('patientWeight'); const heightInput = document.getElementById('heightInput'); const bmiOutput = document.getElementById('bmiOutput'); const weight = parseFloat(weightInput.value); const height = parseFloat(heightInput.value); if (weight > 0 && height > 0) { const heightInMeters = height / 100; const bmi = weight / (heightInMeters * heightInMeters); bmiOutput.value = bmi.toFixed(1); } else { bmiOutput.value = ''; } }
function handleWeightHeightChange() { calculateBMI(); document.querySelectorAll('#continuousDrugsTbody tr').forEach(row => { const doseInput = row.querySelector('.dose'); if (doseInput) calculateInfusionRate(doseInput); }); recalculateAllKgDoses(); }

function addContinuousDrug() { const tbody = document.querySelector('#continuousDrugsTbody'); const newRow = document.createElement('tr'); const rowId = 'cont_' + Date.now(); newRow.innerHTML = `<td><input type="text" class="drug-input drug-name" placeholder="Nazwa leku" list="continuousDrugsList" autocomplete="off" onchange="fillContinuousDrugData(this, '${rowId}')" id="${rowId}_name" /><input type="text" class="drug-input" placeholder="Stężenie" autocomplete="off" id="${rowId}_conc" oninput="calculateInfusionRate(this.closest('tr').querySelector('.dose'))" /></td><td><input type="text" class="drug-input dose" placeholder="Dawka" autocomplete="off" id="${rowId}_dose" oninput="calculateInfusionRate(this)" /></td><td><input type="text" class="drug-input infusion-rate" placeholder="0,0" autocomplete="off" /></td><td><div class="signature-box-cell"></div></td><td class="action-column no-print"><button onclick="removeRow(this)" class="remove-button"><i class="fas fa-times-circle"></i></button></td>`; tbody.appendChild(newRow); }
function fillContinuousDrugData(input, rowId) { const drugName = input.value.toUpperCase(); if (continuousDrugsData[drugName]) { const data = continuousDrugsData[drugName]; const concInput = document.getElementById(rowId + '_conc'); const doseInput = document.getElementById(rowId + '_dose'); const row = input.closest('tr'); const rateOutput = row.querySelector('.infusion-rate'); concInput.value = data.concentration; doseInput.value = data.dose; if (data.fixedRate) { rateOutput.value = data.fixedRate; } else { calculateInfusionRate(doseInput); } } }

function addPeriodicDrug() { const tbody = document.querySelector('#periodicDrugsTbody'); const newRow = document.createElement('tr'); const rowId = 'per_' + Date.now(); newRow.innerHTML = `<td><input type="text" class="drug-input drug-name" placeholder="Nazwa leku" list="periodicDrugsList" autocomplete="off" onchange="fillPeriodicDrugData(this)" id="${rowId}_name" /><input type="text" class="drug-input" placeholder="Dawka" autocomplete="off" id="${rowId}_dose" /></td><td><input type="text" class="drug-input" placeholder="i.v." autocomplete="off" id="${rowId}_route" /><input type="text" class="drug-input" placeholder="co 24h" autocomplete="off" id="${rowId}_freq" /><span class="dose-reduction-notice" style="display:none;">⚠️ Zredukowano</span></td><td><div class="signature-box-cell"></div></td><td class="action-column no-print"><button onclick="removeRow(this)" class="remove-button"><i class="fas fa-times-circle"></i></button></td>`; tbody.appendChild(newRow); }

function fillPeriodicDrugData(input) { 
    const row = input.closest('tr'); 
    const drugName = input.value.toUpperCase(); 
    const doseInput = row.querySelector('input[id$="_dose"]'); 
    const routeInput = row.querySelector('input[id$="_route"]'); 
    const freqInput = row.querySelector('input[id$="_freq"]'); 
    const originalData = periodicDrugsData[drugName]; 
    if (originalData) { 
        doseInput.dataset.originalDose = originalData.dose; 
        routeInput.value = originalData.route; 
        routeInput.placeholder = '';
        freqInput.value = originalData.frequency; 
        freqInput.placeholder = '';
    } else { 
        doseInput.dataset.originalDose = ''; 
        routeInput.placeholder = 'i.v.';
        freqInput.placeholder = 'co 24h';
    } 
    recalculateDose(row); 
    adjustSingleDoseForGfr(row); 
}

function addFluid() { const tbody = document.querySelector('#fluidsTable tbody'); const newRow = document.createElement('tr'); const rowId = 'fluid_' + Date.now(); newRow.innerHTML = `<td><input type="text" class="drug-input fluid-name" placeholder="Płyn" list="fluidsList" autocomplete="off" onchange="fillFluidData(this, '${rowId}')" /></td><td><input type="text" class="drug-input additives-input" placeholder="np. + KCl 15% 10ml | + MgSO4 20% 5ml" autocomplete="off" /></td><td><input type="number" class="drug-input" placeholder="ml" autocomplete="off" id="${rowId}_vol" oninput="updateSummaries()" /></td><td><input type="number" class="drug-input fluid-rate" placeholder="ml/h" autocomplete="off" id="${rowId}_rate" oninput="updateSummaries()" /></td><td><div class="signature-box-cell"></div></td><td class="action-column no-print"><button onclick="removeRow(this)" class="remove-button"><i class="fas fa-times-circle"></i></button></td>`; tbody.appendChild(newRow); }
function fillFluidData(input, rowId) { const fluidName = input.value; if (fluidsData[fluidName]) { document.getElementById(rowId + '_vol').value = fluidsData[fluidName].volume.replace('ml',''); document.getElementById(rowId + '_rate').value = fluidsData[fluidName].rate; updateSummaries(); } }

function addNutrition() { 
    const tbody = document.querySelector('#nutritionTable tbody'); 
    const newRow = document.createElement('tr'); 
    const rowId = 'nutr_' + Date.now();
    newRow.innerHTML = `<td><input type="text" class="drug-input nutrition-type" placeholder="Wybierz typ..." list="nutritionTypesList" autocomplete="off" onchange="updateNutritionProductList(this)" /></td><td><input type="text" class="drug-input nutrition-prep" placeholder="Wybierz preparat..." list="enteralProductsList" autocomplete="off" onchange="fillNutritionData(this, '${rowId}')" id="${rowId}_prep"/><textarea class="drug-input nutrition-additives" placeholder="" id="${rowId}_additives" autocomplete="off" style="display:none;" rows="1"></textarea></td><td><input type="number" class="drug-input nutrition-rate" placeholder="ml/h" autocomplete="off" id="${rowId}_rate" oninput="updateSummaries()" /></td><td><div class="signature-box-cell"></div></td><td class="action-column no-print"><button onclick="removeRow(this)" class="remove-button"><i class="fas fa-times-circle"></i></button></td>`; 
    tbody.appendChild(newRow); 
    
    const newTextarea = newRow.querySelector('.nutrition-additives');
    newTextarea.addEventListener('input', () => autoResizeTextarea(newTextarea));
}

function fillNutritionData(input, rowId) {
    const prepName = input.value;
    const rateInput = document.getElementById(rowId + '_rate');
    const additivesTextarea = document.getElementById(rowId + '_additives');
    const row = input.closest('tr');
    const typeInput = row.querySelector('.nutrition-type');
    const typeValue = typeInput ? typeInput.value.toLowerCase() : '';
    
    if (nutritionFlowRates[prepName] && !rateInput.value) {
        rateInput.value = nutritionFlowRates[prepName];
    }
    
    if (typeValue.includes('pozajelitowe') && additivesTextarea) {
        if (prepName.includes('SmofKabiven') || prepName.includes('OMEGAFLEX') || prepName.includes('Nutriflex') || prepName.includes('Aminomix')) {
            if (!additivesTextarea.value) {
                additivesTextarea.value = '+ Glycophos 3ml + Supliven 10ml + Omegaven 50ml + Soluvit N 1amp + Vitalipid 10ml';
                autoResizeTextarea(additivesTextarea); // Zmień rozmiar po auto-uzupełnieniu
            }
        }
    }
    
    updateSummaries();
}
function updateNutritionProductList(typeInput) { 
    const row = typeInput.closest('tr'); 
    const prepInput = row.querySelector('.nutrition-prep'); 
    const additivesInput = row.querySelector('.nutrition-additives');
    const typeValue = typeInput.value.toLowerCase(); 
    
    let newListId = 'enteralProductsList';
    if (typeValue.includes('dojelitowe')) { 
        newListId = 'enteralProductsList';
        if (additivesInput) {
            additivesInput.style.display = 'none';
            additivesInput.value = '';
        }
    } else if (typeValue.includes('pozajelitowe')) { 
        newListId = 'parenteralProductsList';
        if (additivesInput) {
            additivesInput.style.display = 'block';
            additivesInput.placeholder = 'np. + Glycophos 3ml + Supliven 10ml...';
        }
    } else { 
        if (additivesInput) {
            additivesInput.style.display = 'none';
            additivesInput.value = '';
        }
    } 
    
    prepInput.setAttribute('list', newListId);
    prepInput.value = ''; 
    
    updateSummaries(); 
}

function addProcedure() { const tbody = document.querySelector('#proceduresTable tbody'); const newRow = document.createElement('tr'); newRow.innerHTML = `<td><input type="text" class="drug-input" placeholder="Godz." list="timesList" autocomplete="off" /></td><td><input type="text" class="drug-input" placeholder="Nazwa procedury/zabiegu" list="proceduresList" autocomplete="off" /></td><td><div class="signature-box-cell"></div></td><td class="action-column no-print"><button onclick="removeRow(this)" class="remove-button"><i class="fas fa-times-circle"></i></button></td>`; tbody.appendChild(newRow); }

// --- LOGIKA DAWKOWANIA (GFR, mg/kg) ---
function recalculateDose(row) { 
    const doseInput = row.querySelector('input[id$="_dose"]'); 
    const originalDose = doseInput.dataset.originalDose; 
    const weight = parseFloat(document.getElementById('patientWeight').value); 
    
    if (originalDose && originalDose.includes('/kg') && weight > 0) { 
        const doseRegex = /([\d\.]+)(?:\s*-\s*([\d\.]+))?/; 
        const matches = originalDose.match(doseRegex); 
        if (matches) { 
            const dose1 = parseFloat(matches[1]); 
            const totalDose1 = Math.round(dose1 * weight); 
            if (matches[2]) { 
                const dose2 = parseFloat(matches[2]); 
                const totalDose2 = Math.round(dose2 * weight); 
                doseInput.value = `${totalDose1}-${totalDose2}mg (${originalDose})`; 
            } else { 
                doseInput.value = `${totalDose1}mg (${originalDose})`; 
            } 
        } 
    } else if (originalDose) { 
        doseInput.value = originalDose; 
    } 
}

function recalculateAllKgDoses(){ 
    document.querySelectorAll('#periodicDrugsTbody tr').forEach(row => recalculateDose(row)); 
    adjustAllDosesForGfr(); 
}

function adjustAllDosesForGfr() { 
    document.querySelectorAll('#periodicDrugsTbody tr').forEach(row => adjustSingleDoseForGfr(row)); 
}

function adjustSingleDoseForGfr(row) {
    const gfrInput = document.getElementById('gfrInput');
    const gfr = gfrInput.value ? parseFloat(gfrInput.value) : null;
    const drugNameInput = row.querySelector('.drug-name');
    if (!drugNameInput || !drugNameInput.value) return;

    const drugName = drugNameInput.value.toUpperCase();
    const doseInput = row.querySelector('input[id$="_dose"]');
    const freqInput = row.querySelector('input[id$="_freq"]');
    const notice = row.querySelector('.dose-reduction-notice');
    const adjustmentRules = gfrDoseAdjustments[drugName];

    recalculateDose(row);
    row.classList.remove('gfr-dose-adjusted');
    if (notice) notice.style.display = 'none';

    if (!gfr || !adjustmentRules) return;

    let appliedRule = null;
    for (const rule of adjustmentRules) { 
        if (gfr <= rule.gfrMax) { 
            appliedRule = rule; 
            break; 
        } 
    }

    if (appliedRule) {
        if (appliedRule.dose.includes('/kg')) {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            if (weight > 0) {
                const doseRegex = /([\d\.]+)/; 
                const matches = appliedRule.dose.match(doseRegex);
                if(matches) { 
                    const totalDose = Math.round(parseFloat(matches[1]) * weight); 
                    doseInput.value = `${totalDose}mg (${appliedRule.dose})`; 
                }
            } else { 
                doseInput.value = appliedRule.dose; 
            }
        } else { 
            doseInput.value = appliedRule.dose; 
        }
        
        if (appliedRule.frequency && freqInput) freqInput.value = appliedRule.frequency;
        row.classList.add('gfr-dose-adjusted');
        if (notice) notice.style.display = 'inline';
        
        // Show warning toast for first adjustment
        if (!row.dataset.gfrWarningShown) {
            showToast('Dostosowano dawkę', `Dawka ${drugName} została dostosowana do GFR=${gfr}`, 'warning', 6000);
            row.dataset.gfrWarningShown = 'true';
        }
    }
}

function populateDatalists() {
    const createOptions = (dataObject) => Object.keys(dataObject).map(key => `<option value="${key}"></option>`).join('');
    document.getElementById('continuousDrugsList').innerHTML = createOptions(continuousDrugsData);
    document.getElementById('periodicDrugsList').innerHTML = createOptions(periodicDrugsData);
    document.getElementById('fluidsList').innerHTML = createOptions(fluidsData);
    
    const enteral = {};
    const parenteral = {};
    Object.keys(nutritionData).forEach(key => {
        if (key.includes('OMEGAFLEX') || key.includes('Nutriflex') || key.includes('SmofKabiven') || key.includes('Aminomix')) {
            parenteral[key] = nutritionData[key];
        } else {
            enteral[key] = nutritionData[key];
        }
    });
    
    document.getElementById('enteralProductsList').innerHTML = createOptions(enteral);
    document.getElementById('parenteralProductsList').innerHTML = createOptions(parenteral);
}

function initializeCard() { 
    const today = new Date(); 
    const day = String(today.getDate()).padStart(2, '0'); 
    const month = String(today.getMonth() + 1).padStart(2, '0'); 
    const year = today.getFullYear(); 
    document.getElementById('mainDateInput').value = `${day}.${month}.${year}`; 
    calculateIcuDay(); 
    calculateBMI(); 
    updateAutosaveIndicator('saved', 'Wszystkie zmiany zapisane');
}

// --- ENHANCED SAVE/LOAD SYSTEM ---
function saveCard() {
    const patientName = document.getElementById('patientNameInput').value.trim();
    const historyNumber = document.getElementById('historyNumberInput').value.trim();
    
    if (!patientName || !historyNumber) {
        showToast('Brak danych', 'Proszę wypełnić Imię i Nazwisko oraz Numer Historii, aby zapisać kartę.', 'warning');
        
        // Highlight required fields
        if (!patientName) {
            document.getElementById('patientNameInput').classList.add('field-error');
            setTimeout(() => document.getElementById('patientNameInput').classList.remove('field-error'), 3000);
        }
        if (!historyNumber) {
            document.getElementById('historyNumberInput').classList.add('field-error');
            setTimeout(() => document.getElementById('historyNumberInput').classList.remove('field-error'), 3000);
        }
        return;
    }
    
    const cardKey = `card_${patientName.replace(/\s+/g, '-')}_${historyNumber.replace(/[\/\s]+/g, '-')}`;
    const cardState = getCardState();

    try {
        // Add metadata
        cardState.metadata = {
            savedAt: new Date().toISOString(),
            version: '2.0',
            patientSummary: {
                name: patientName,
                historyNumber: historyNumber,
                diagnosis: document.getElementById('diagnosisInput').value || 'Brak rozpoznania'
            }
        };
        
        const storageKey = isOnline ? cardKey : `offline_${cardKey}`;
        localStorage.setItem(storageKey, JSON.stringify(cardState));
        
        let savedCardsIndex = JSON.parse(localStorage.getItem('savedCardsIndex') || '[]');
        if (!savedCardsIndex.includes(cardKey)) {
            savedCardsIndex.push(cardKey);
            localStorage.setItem('savedCardsIndex', JSON.stringify(savedCardsIndex));
        }
        
        hasUnsavedChanges = false;
        updateAutosaveIndicator('saved', 'Wszystkie zmiany zapisane');
        
        showToast('Zapisano', 'Karta została pomyślnie zapisana!', 'success');
        
    } catch (e) {
        console.error("Błąd zapisu:", e);
        showToast('Błąd zapisu', 'Wystąpił błąd podczas zapisu karty. Spróbuj ponownie.', 'error');
    }
}

function openLoadModal() {
    const savedCardsIndex = JSON.parse(localStorage.getItem('savedCardsIndex') || '[]');
    const listElement = document.getElementById('savedCardsList');
    listElement.innerHTML = '';
    
    if (savedCardsIndex.length === 0) {
        listElement.innerHTML = '<li style="text-align: center; padding: 20px; color: var(--gray-500);">Brak zapisanych kart.</li>';
    } else {
        // Sort by most recent
        const cardsWithDates = savedCardsIndex.map(key => {
            const data = localStorage.getItem(key);
            let savedAt = null;
            try {
                const parsed = JSON.parse(data);
                savedAt = parsed.metadata?.savedAt ? new Date(parsed.metadata.savedAt) : new Date(0);
            } catch(e) {
                savedAt = new Date(0);
            }
            return { key, savedAt };
        }).sort((a, b) => b.savedAt - a.savedAt);
        
        cardsWithDates.forEach(({key, savedAt}) => {
            const friendlyName = key.replace('card_', '').replace(/_/g, ' ');
            const timeAgo = getTimeAgo(savedAt);
            
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    <div class="patient-name">${friendlyName}</div>
                    <div style="font-size: 11px; color: var(--gray-500); margin-top: 2px;">Zapisano: ${timeAgo}</div>
                </div>
                <div>
                    <button class="control-button load small" onclick="loadCard('${key}')">Wczytaj</button>
                    <button class="control-button clear small" onclick="deleteCard('${key}', this)">Usuń</button>
                </div>`;
            listElement.appendChild(li);
        });
    }
    
    document.getElementById('loadCardModal').style.display = 'flex';
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) return `${diffMins} min temu`;
    if (diffHours < 24) return `${diffHours}h temu`;
    if (diffDays < 7) return `${diffDays} dni temu`;
    return date.toLocaleDateString('pl-PL');
}

function deleteCard(cardKey, button) {
    const friendlyName = cardKey.replace('card_', '').replace(/_/g, ' ');
    if (confirm(`Czy na pewno chcesz usunąć kartę: ${friendlyName}?`)) {
        localStorage.removeItem(cardKey);
        let savedCardsIndex = JSON.parse(localStorage.getItem('savedCardsIndex') || '[]');
        savedCardsIndex = savedCardsIndex.filter(key => key !== cardKey);
        localStorage.setItem('savedCardsIndex', JSON.stringify(savedCardsIndex));
        button.closest('li').remove();
        
        showToast('Usunięto', `Karta "${friendlyName}" została usunięta`, 'info');
    }
}

function loadCard(cardKey) {
    const savedStateJSON = localStorage.getItem(cardKey);
    if (!savedStateJSON) {
        showToast('Błąd', 'Nie można wczytać karty. Mogła zostać usunięta.', 'error');
        return;
    }
    
    try {
        const cardState = JSON.parse(savedStateJSON);
        populateCardFromState(cardState);
        closeModal('loadCardModal');
        
        const patientName = cardState.metadata?.patientSummary?.name || 'Pacjent';
        showToast('Wczytano', `Pomyślnie wczytano kartę dla: ${patientName}`, 'success');
        
    } catch (e) {
        console.error('Load error:', e);
        showToast('Błąd', 'Wystąpił błąd podczas wczytywania karty.', 'error');
    }
}

function populateCardFromState(cardState) {
    clearCard(true);
    
    // Restore header data
    Object.keys(cardState.header || {}).forEach(id => {
        const input = document.getElementById(id);
        if (input) input.value = cardState.header[id];
    });
    
    // Sync room fields
    const roomInput = document.getElementById('roomInput');
    const roomInputPrint = document.getElementById('roomInputPrint');
    if (roomInput && roomInputPrint && roomInput.value) {
        roomInputPrint.value = roomInput.value;
    }
    
    // Restore tables data with enhanced features
    const tables = cardState.tables || {};
    
    // Continuous drugs
    (tables.continuous || []).forEach(data => {
        addContinuousDrug();
        const newRow = document.querySelector('#continuousDrugsTbody tr:last-child');
        const inputs = newRow.querySelectorAll('input');
        inputs[1].value = data.name; // Skip drag handle
        inputs[2].value = data.conc;
        inputs[3].value = data.dose;
        inputs[4].value = data.rate;
        
        // Trigger autofill
        if (data.name) {
            fillContinuousDrugData(inputs[1], inputs[1].id.replace('_name', ''));
        }
    });
    
    // Periodic drugs
    (tables.periodic || []).forEach(data => {
        addPeriodicDrug();
        const newRow = document.querySelector('#periodicDrugsTbody tr:last-child');
        const inputs = newRow.querySelectorAll('input');
        inputs[1].value = data.name; // Skip drag handle
        inputs[2].value = data.dose;
        inputs[3].value = data.route;
        inputs[4].value = data.freq;
        
        // Trigger autofill
        if (data.name) {
            fillPeriodicDrugData(inputs[1]);
        }
    });
    
    // Fluids
    (tables.fluids || []).forEach(data => {
        addFluid();
        const newRow = document.querySelector('#fluidsTable tbody tr:last-child');
        const inputs = newRow.querySelectorAll('input');
        inputs[1].value = data.name; // Skip drag handle
        inputs[2].value = data.additives || '';
        inputs[3].value = data.volume || '';
        inputs[4].value = data.rate || '';
    });
    
    // Nutrition
    (tables.nutrition || []).forEach(data => {
        addNutrition();
        const newRow = document.querySelector('#nutritionTable tbody tr:last-child');
        const typeInput = newRow.querySelector('.nutrition-type');
        const prepInput = newRow.querySelector('.nutrition-prep');
        const additivesTextarea = newRow.querySelector('.nutrition-additives');
        const rateInput = newRow.querySelector('.nutrition-rate');
        
        if (data.type) {
            typeInput.value = data.type;
            updateNutritionProductList(typeInput);
        }
        if (data.prep) prepInput.value = data.prep;
        if (data.additives && additivesTextarea) {
            additivesTextarea.value = data.additives;
            autoResizeTextarea(additivesTextarea);
        }
        if (data.rate) rateInput.value = data.rate;
    });
    
    // Procedures
    (tables.procedures || []).forEach(data => {
        addProcedure();
        const newRow = document.querySelector('#proceduresTable tbody tr:last-child');
        const inputs = newRow.querySelectorAll('input');
        inputs[1].value = data.time || ''; // Skip drag handle
        inputs[2].value = data.name || '';
    });
    
    // Restore notes
    if (cardState.notes) {
        document.querySelector('.notes-section textarea').value = cardState.notes;
    }
    
    // Recalculate everything
    handleWeightHeightChange();
    updateSummaries();
    adjustAllDosesForGfr();
    
    hasUnsavedChanges = false;
    updateAutosaveIndicator('saved', 'Wszystkie zmiany zapisane');
}

function getCardState() {
    const cardState = {
        header: {},
        tables: {
            continuous: [],
            periodic: [],
            fluids: [],
            nutrition: [],
            procedures: []
        },
        notes: ''
    };
    
    // Save header data
    document.querySelectorAll('.header-input').forEach(input => {
        if (input.id) cardState.header[input.id] = input.value;
    });
    
    // Save table data (skip drag handles)
    document.querySelectorAll('#continuousDrugsTbody tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        cardState.tables.continuous.push({
            name: inputs[1]?.value || '', // Skip drag handle
            conc: inputs[2]?.value || '',
            dose: inputs[3]?.value || '',
            rate: inputs[4]?.value || ''
        });
    });
    
    document.querySelectorAll('#periodicDrugsTbody tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        cardState.tables.periodic.push({
            name: inputs[1]?.value || '', // Skip drag handle
            dose: inputs[2]?.value || '',
            route: inputs[3]?.value || '',
            freq: inputs[4]?.value || ''
        });
    });
    
    document.querySelectorAll('#fluidsTable tbody tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        cardState.tables.fluids.push({
            name: inputs[1]?.value || '', // Skip drag handle
            additives: inputs[2]?.value || '',
            volume: inputs[3]?.value || '',
            rate: inputs[4]?.value || ''
        });
    });
    
    document.querySelectorAll('#nutritionTable tbody tr').forEach(row => {
        cardState.tables.nutrition.push({
            type: row.querySelector('.nutrition-type')?.value || '',
            prep: row.querySelector('.nutrition-prep')?.value || '',
            additives: row.querySelector('.nutrition-additives')?.value || '',
            rate: row.querySelector('.nutrition-rate')?.value || ''
        });
    });
    
    document.querySelectorAll('#proceduresTable tbody tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        cardState.tables.procedures.push({
            time: inputs[1]?.value || '', // Skip drag handle
            name: inputs[2]?.value || ''
        });
    });
    
    cardState.notes = document.querySelector('.notes-section textarea').value;
    return cardState;
}

function clearCard(force = false) { 
    if (force || confirm('Czy na pewno chcesz wyczyścić całą kartę?')) { 
        document.querySelectorAll('input, textarea').forEach(input => { 
            if(!input.closest('.no-clear') && input.id !== 'roomInputPrint') {
                input.value = ''; 
                input.classList.remove('field-error', 'field-warning', 'field-success');
            }
        }); 
        
        const roomInputPrint = document.getElementById('roomInputPrint');
        if (roomInputPrint) roomInputPrint.value = '';
        
        document.querySelectorAll('tbody').forEach(tbody => { 
            tbody.innerHTML = ''; 
        }); 
        
        updateSummaries(); 
        initializeCard(); 
        
        hasUnsavedChanges = false;
        updateAutosaveIndicator('saved', 'Wszystkie zmiany zapisane');
        
        if (!force) {
            showToast('Wyczyszczono', 'Karta została wyczyszczona', 'info');
        }
    } 
}

function generatePDF() {
    const element = document.getElementById('card-container');
    const patientName = document.getElementById('patientNameInput').value.trim() || 'Pacjent';
    const date = document.getElementById('mainDateInput').value || 'aktualna_data';
    const filename = `Karta_OIT_${patientName.replace(/\s+/g, '_')}_${date.replace(/\./g, '-')}.pdf`;
    
    showToast('Generowanie PDF', 'Przygotowywanie dokumentu do pobrania...', 'info');
    
    const opt = { 
        margin: 10, 
        filename: filename, 
        image: { type: 'jpeg', quality: 0.98 }, 
        html2canvas: { scale: 2, useCORS: true }, 
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
        showToast('PDF utworzony', `Plik ${filename} został pobrany`, 'success');
    }).catch((error) => {
        showToast('Błąd PDF', 'Wystąpił problem podczas tworzenia PDF', 'error');
        console.error('PDF Error:', error);
    });
}

function closeModal(modalId) { 
    document.getElementById(modalId).style.display = 'none'; 
}

// --- FILE SAVE/LOAD ---
function saveCardToFile() {
    const patientName = document.getElementById('patientNameInput').value.trim() || 'Pacjent';
    const historyNumber = document.getElementById('historyNumberInput').value.trim() || 'XXXX';
    const filename = `KartaOIT_${patientName.replace(/\s+/g, '_')}_${historyNumber.replace(/[\/\s]+/g, '-')}.json`;

    const cardState = getCardState();
    cardState.metadata = {
        exportedAt: new Date().toISOString(),
        version: '2.0',
        application: 'Medical Card System',
        patientSummary: {
            name: patientName,
            historyNumber: historyNumber
        }
    };
    
    const fileContent = JSON.stringify(cardState, null, 2);
    const blob = new Blob([fileContent], { type: 'application/json' });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    
    showToast('Zapisano do pliku', `Plik ${filename} został pobrany`, 'success');
}

function loadCardFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const cardState = JSON.parse(e.target.result);
            
            if (cardState.header && cardState.tables) {
                if (confirm('Czy na pewno chcesz wczytać dane z pliku? Obecne dane zostaną zastąpione.')) {
                    populateCardFromState(cardState);
                    
                    const patientName = cardState.metadata?.patientSummary?.name || 'Pacjent';
                    showToast('Wczytano z pliku', `Pomyślnie wczytano kartę: ${patientName}`, 'success');
                }
            } else {
                showToast('Błędny plik', 'Wybrany plik ma nieprawidłową strukturę.', 'error');
            }
        } catch (error) {
            showToast('Błąd pliku', 'Nie można odczytać pliku. Upewnij się, że to prawidłowy plik zapisu (.json).', 'error');
            console.error("Błąd parsowania pliku JSON:", error);
        }
    };
    
    reader.onerror = function() {
        showToast('Błąd odczytu', 'Wystąpił błąd podczas odczytu pliku.', 'error');
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

// --- MAIN INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Initialize all systems
    populateDatalists();
    setupKeyboardShortcuts();
    setupSearchInput();
    setupValidation();
    setupOfflineMode();
    initializeDragAndDrop();
    startAutosave();
    
    // Dark mode toggle
    const toggle = document.getElementById('darkModeToggle'); 
    const html = document.documentElement; 
    const icon = toggle.querySelector('i'); 
    
    if (localStorage.getItem('darkMode') === 'enabled') { 
        html.classList.add('dark-mode'); 
        icon.className = 'fas fa-sun'; 
    } 
    
    toggle.addEventListener('click', () => { 
        html.classList.toggle('dark-mode'); 
        if (html.classList.contains('dark-mode')) { 
            localStorage.setItem('darkMode', 'enabled'); 
            icon.className = 'fas fa-sun'; 
            showToast('Tryb ciemny', 'Włączono tryb ciemny', 'info');
        } else { 
            localStorage.setItem('darkMode', 'disabled'); 
            icon.className = 'fas fa-moon';
            showToast('Tryb jasny', 'Włączono tryb jasny', 'info');
        } 
    }); 
    
    // Room input sync
    const roomInput = document.getElementById('roomInput');
    const roomInputPrint = document.getElementById('roomInputPrint');
    if (roomInput && roomInputPrint) {
        roomInput.addEventListener('input', function() {
            roomInputPrint.value = this.value;
            markAsChanged();
        });
    }
    
    // Add change listeners for autosave
    document.addEventListener('input', function(e) {
        if (e.target.matches('input, textarea, select')) {
            markAsChanged();
        }
    });
    
    // Patient name change listener for autosave restore
    document.getElementById('patientNameInput').addEventListener('blur', function() {
        if (this.value.trim()) {
            setTimeout(() => restoreFromAutosave(), 500);
        }
    });
    
    // Initialize card
    initializeCard();
    
    // Show welcome message
    setTimeout(() => {
        showToast('System gotowy', 'Karta Zleceń OIT - wszystkie funkcje aktywne', 'success');
    }, 1000);
    
    console.log('🏥 Medical Card System v2.0 - Enhanced Edition loaded successfully!');
});

// --- UTILITY FUNCTIONS ---
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Debounced autosave trigger
const debouncedMarkAsChanged = debounce(markAsChanged, 1000);

// Prevent accidental page close with unsaved changes
window.addEventListener('beforeunload', function (e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'Masz niezapisane zmiany. Czy na pewno chcesz opuścić stronę?';
        return e.returnValue;
    }
});

// Add floating search button
document.addEventListener('DOMContentLoaded', () => {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '🔍';
    fab.title = 'Szybkie wyszukiwanie leków (Ctrl+F)';
    fab.onclick = openSearchModal;
    document.body.appendChild(fab);
});
    </script>
</body>
</html>
