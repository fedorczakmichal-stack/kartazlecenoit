<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytowalna Karta Zleceń OIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="toastContainer"></div>

    <div class="top-controls no-print">
        <button onclick="window.print()" class="control-button print"><i class="fas fa-print"></i> Drukuj</button>
        <button onclick="generatePDF()" class="control-button pdf"><i class="fas fa-file-pdf"></i> PDF</button>
        <button onclick="saveCard()" class="control-button save"><i class="fas fa-save"></i> Zapisz w przeglądarce</button>
        <button onclick="openLoadModal()" class="control-button load"><i class="fas fa-folder-open"></i> Wczytaj z przeglądarki</button>
        <button onclick="saveCardToFile()" class="control-button save-file"><i class="fas fa-file-download"></i> Zapisz do pliku</button>
        <button onclick="document.getElementById('fileInput').click()" class="control-button load-file"><i class="fas fa-file-upload"></i> Wczytaj z pliku</button>
        <input type="file" id="fileInput" style="display: none;" onchange="loadCardFromFile(event)" accept=".json">
        <button onclick="clearCard()" class="control-button clear"><i class="fas fa-trash"></i> Wyczyść</button>
        <button id="darkModeToggle" class="control-button dark-mode"><i class="fas fa-moon"></i></button>
        <div id="autosaveIndicator" class="autosave-indicator saved">
            <i class="fas fa-check-circle"></i>
            <span></span>
        </div>
    </div>

    <div class="container" id="card-container">
        <div class="header-section">
            <div class="hospital-header">
                <div class="hospital-logo">
                    <div class="logo-icon">🏥</div>
                    <div>
                        <div style="font-size: 13px; font-weight: 600;">Szpital Zakonu Bonifratrów św. Jana Bożego w Łodzi</div>
                        <div style="font-size: 10px; opacity: 0.9;">ul. Kosynierów Gdyńskich 61, 93-357 Łódź</div>
                    </div>
                </div>
                <div class="header-right-info">
                    <div class="field-group">
                        <span class="field-label">Data</span>
                        <input type="text" id="mainDateInput" class="field-value small header-input" autocomplete="off" onchange="calculateIcuDay()"/>
                    </div>
                    <div class="field-group">
                        <span class="field-label">Doba w OIT</span>
                        <input type="number" min="0" id="icuDayInput" class="field-value small header-input" autocomplete="off"/>
                    </div>
                    <div class="field-group print-only-room" style="display:none;">
                        <span class="field-label">Sala/Łóżko</span>
                        <input type="text" id="roomInputPrint" class="field-value small header-input" autocomplete="off" readonly/>
                    </div>
                </div>
            </div>
            <h1>Oddział Anestezjologii i Intensywnej Terapii - Karta Zleceń Lekarskich</h1>
        </div>

        <div class="patient-card">
            <div class="patient-grid">
                <div class="field-group" style="grid-column: span 2;">
                    <span class="field-label">Imię i Nazwisko</span>
                    <input type="text" id="patientNameInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">PESEL</span>
                    <input type="text" id="peselInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Nr Historii</span>
                    <input type="text" id="historyNumberInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Data przyjęcia</span>
                    <input type="text" placeholder="DD.MM.RRRR" id="admissionDateInput" class="field-value header-input" autocomplete="off" onchange="calculateIcuDay()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Waga (kg)</span>
                    <input type="number" id="patientWeight" class="field-value header-input" autocomplete="off" oninput="handleWeightHeightChange()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">Wzrost (cm)</span>
                    <input type="number" id="heightInput" class="field-value header-input" autocomplete="off" oninput="handleWeightHeightChange()"/>
                </div>
                <div class="field-group">
                    <span class="field-label">BMI</span>
                    <input type="text" id="bmiOutput" class="field-value header-input" autocomplete="off" readonly/>
                </div>
                <div class="field-group" style="grid-column: span 2;">
                    <span class="field-label">Rozpoznanie</span>
                    <input type="text" id="diagnosisInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group">
                    <span class="field-label">GFR (ml/min)</span>
                    <input type="number" id="gfrInput" class="field-value gfr-input header-input" autocomplete="off" oninput="adjustAllDosesForGfr()"/>
                </div>
                 <div class="field-group">
                    <span class="field-label">Sala/Łóżko</span>
                    <input type="text" id="roomInput" class="field-value header-input" autocomplete="off"/>
                </div>
                <div class="field-group" style="grid-column: span 4;">
                    <span class="field-label">⚠️ ALERGIE / NIETOLERANCJE</span>
                    <input type="text" id="allergiesInput" class="field-value alert-field header-input" autocomplete="off"/>
                </div>
            </div>
        </div>

        <div class="section-header"><i class="fas fa-syringe"></i> LEKI CIĄGŁE - POMPY INFUZYJNE</div>
        <table id="continuousDrugsTable">
            <thead>
                <tr>
                    <th style="width: 35%;">Lek / Stężenie</th>
                    <th style="width: 25%;">Dawka</th>
                    <th style="width: 15%;">Prędkość [ml/h]</th>
                    <th style="width: 25%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="continuousDrugsTbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addContinuousDrug()" class="add-button"><i class="fas fa-plus-circle"></i> Dodaj lek ciągły</button>
        </div>

        <div class="section-header green"><i class="fas fa-pills"></i> LEKI OKRESOWE</div>
        <table id="periodicDrugsTable">
            <thead>
                <tr>
                    <th style="width: 30%;">Lek / Dawka</th>
                    <th style="width: 15%;">Droga / Częstość</th>
                    <th style="width: 55%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="periodicDrugsTbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addPeriodicDrug()" class="add-button green"><i class="fas fa-plus-circle"></i> Dodaj lek okresowy</button>
        </div>

        <div class="section-header cyan"><i class="fas fa-tint"></i> PŁYNOTERAPIA I ŻYWIENIE</div>
        <table id="fluidsTable">
             <thead>
                <tr>
                    <th style="width: 20%;">Płyn</th>
                    <th style="width: 35%;">Dodatki</th>
                    <th style="width: 10%;">Objętość [ml]</th>
                    <th style="width: 10%;">Prędkość [ml/h]</th>
                    <th style="width: 25%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="fluidsTbody"></tbody>
        </table>
        <table id="nutritionTable">
            <thead>
                <tr>
                    <th style="width: 25%;">Typ żywienia</th>
                    <th style="width: 35%;">Preparat / Dawka</th>
                    <th style="width: 15%;">Prędkość [ml/h]</th>
                    <th style="width: 25%;">Podpis pielęgniarki</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="nutritionTbody"></tbody>
        </table>

        <div class="controls-summary-container">
             <div class="button-container no-print">
                <button onclick="addFluid()" class="add-button cyan"><i class="fas fa-plus-circle"></i> Dodaj płyn</button>
                <button onclick="addNutrition()" class="add-button orange"><i class="fas fa-plus-circle"></i> Dodaj żywienie</button>
            </div>
            <div class="summary-container">
                <div id="fluidBalanceSummary">Suma płynów / 24h: <strong><span id="totalFluids">0</span> ml</strong></div>
                <div class="fluid-balance-bar-container">
                    <div id="fluidBalanceBar" class="fluid-balance-bar"></div>
                </div>
                <div id="kcalSummary">Suma kcal / 24h: <strong><span id="totalKcal">0</span> kcal</strong></div>
                <div id="kcalPerKgSummary"><strong><span id="kcalPerKg">0</span> kcal/kg</strong></div>
            </div>
        </div>

        <div class="section-header purple"><i class="fas fa-stethoscope"></i> PROCEDURY / ZABIEGI</div>
        <table id="proceduresTable">
            <thead>
                <tr>
                    <th style="width: 15%;">Godzina</th>
                    <th style="width: 50%;">Procedura</th>
                    <th style="width: 35%;">Wykonano (podpis)</th>
                    <th class="action-column no-print"></th>
                </tr>
            </thead>
            <tbody id="proceduresTbody"></tbody>
        </table>
        <div class="button-container no-print">
            <button onclick="addProcedure()" class="add-button purple"><i class="fas fa-plus-circle"></i> Dodaj procedurę</button>
        </div>

        <div class="section-header gray"><i class="fas fa-file-alt"></i> UWAGI DODATKOWE / ZALECENIA</div>
        <div class="footer-grid">
            <div class="notes-section">
                <textarea placeholder="Miejsce na dodatkowe zalecenia, uwagi, konsultacje..." autocomplete="off"></textarea>
            </div>
            <div class="signature-box">
                <div class="signature-line"></div>
                <div class="signature-label">LEKARZ DYŻURNY</div>
                <div class="signature-sublabel">(pieczątka i podpis)</div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Rejestracja Service Workera dla trybu offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
